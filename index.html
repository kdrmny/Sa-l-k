<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meditek ‚Ä¢ Tedarik Vitrini & Paneller</title>
<style>
/* ========== TOKENS ========== */
:root{
  --bg: #fbfbfc;
  --ink: #0f1720;
  --muted: #5f6b77;
  --line: #e6e8ec;

  --glass-bg: rgba(255,255,255,.72);
  --glass-br: 20px;
  --glass-blur: 28px;
  --glass-border: rgba(255,255,255,.65);
  --glass-shadow: 0 10px 30px rgba(15, 23, 32, .08);

  --accent: #111;
  --accent-ink: #fff;

  --ok: #16a34a;
  --warn: #f59e0b;
  --info: #2563eb;
  --danger:#dc2626;

  --chip-bg:#f3f4f6;

  --radius:18px;
}

html[data-theme="dark"]{
  --bg: #0c0d0f;
  --ink: #f3f5f7;
  --muted:#9aa3ad;
  --line:#2a2e33;

  --glass-bg: rgba(20,22,26,.70);
  --glass-br: 20px;
  --glass-blur: 26px;
  --glass-border: rgba(255,255,255,.14);
  --glass-shadow: 0 20px 40px rgba(0,0,0,.45);

  --accent:#e5e7eb;
  --accent-ink:#111;

  --chip-bg:#161a1f;
}

*{box-sizing:border-box} body{
  margin:0; background:
  radial-gradient(1200px 600px at -10% -10%, rgba(0,0,0,.06), transparent 60%),
  radial-gradient(900px 500px at 110% 10%, rgba(0,0,0,.05), transparent 60%),
  var(--bg);
  color:var(--ink); font: 500 15px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Helvetica,Arial;
}

/* NAV */
.nav{
  position:sticky; top:16px; z-index:9;
  width:min(1100px,92%); margin:16px auto 12px;
  padding:10px 14px; border-radius:24px;
  background:var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur)) saturate(1.05);
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.05);
  border:1px solid var(--glass-border);
  box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255,255,255,.45);
}
.nav .row{display:flex; align-items:center; gap:10px; justify-content:space-between}
.nav .brand{font-weight:800; letter-spacing:.2px}
.nav .pill{display:flex; gap:6px; align-items:center}
.btn, .chip{
  border:1px solid var(--line); border-radius:14px;
  background:transparent; color:var(--ink);
  padding:8px 12px; cursor:pointer;
}
.btn:hover{background:var(--chip-bg)}
.btn.primary{border-color:var(--accent); background:var(--accent); color:var(--accent-ink)}
.switch{
  border:1px solid var(--line); border-radius:14px; display:flex; padding:3px; gap:3px;
  background:var(--chip-bg)
}
.switch button{
  border:none; background:transparent; padding:6px 10px; border-radius:10px; color:var(--muted); cursor:pointer
}
.switch button.active{background:var(--ink); color:var(--bg)}

/* LAYOUT */
.wrap{width:min(1100px,92%); margin:24px auto 80px}
.section{margin:18px 0}
.glass{
  background:var(--glass-bg);
  border-radius:var(--glass-br);
  backdrop-filter: blur(var(--glass-blur)) saturate(1.08) contrast(1.03);
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.08) contrast(1.03);
  border:1px solid var(--glass-border);
  box-shadow: var(--glass-shadow), inset 0 1px 0 rgba(255,255,255,.55);
  padding:22px;
}
h1{font-size:40px; margin:8px 0 6px}
h2{font-size:22px; margin:0 0 12px}
.sub{color:var(--muted)}

/* GRID */
.grid{display:grid; gap:14px}
.grid.cards{grid-template-columns: repeat(auto-fit,minmax(280px,1fr))}

/* CARDS */
.card{padding:18px; border-radius:var(--radius); border:1px solid var(--line); background:rgba(255,255,255,.82)}
html[data-theme="dark"] .card{background:rgba(22,24,28,.78)}
.card .title{font-weight:700; font-size:16px}
.meta{display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 2px}
.chip{background:var(--chip-bg); border-color:transparent; color:var(--ink)}
.badge{padding:4px 10px; border-radius:999px; font:700 11px/1 ui-sans-serif; display:inline-flex; gap:6px; align-items:center}
.badge.ok{background:rgba(22,163,74,.1); color:var(--ok)}
.badge.warn{background:rgba(245,158,11,.12); color:var(--warn)}
.badge.info{background:rgba(37,99,235,.12); color:var(--info)}
.badge.muted{background:var(--chip-bg); color:var(--muted)}

/* DRAWER */
.drawer{
  position:fixed; inset:0; display:none;
}
.drawer.on{display:block}
.drawer .mask{
  position:absolute; inset:0; background:rgba(0,0,0,.3)
}
.drawer .panel{
  position:absolute; top:0; left:0; height:100%; width:min(420px,92%);
  background:var(--glass-bg); backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  border-right:1px solid var(--glass-border); padding:20px; overflow:auto
}
.drawer h3{margin:0 0 12px}
.rowv{display:flex; flex-wrap:wrap; gap:10px}

/* TABLE */
.table{width:100%; border-collapse:collapse; border:1px solid var(--line); border-radius:12px; overflow:hidden}
.table th, .table td{padding:10px 12px; border-bottom:1px solid var(--line); text-align:left}
.table th{background:var(--chip-bg)}

/* CHAT */
.chat{
  display:grid; grid-template-columns:260px 1fr; gap:14px
}
.threads{border:1px solid var(--line); border-radius:12px; overflow:hidden; height:420px; display:flex; flex-direction:column}
.threads .item{padding:12px; border-bottom:1px solid var(--line); cursor:pointer}
.threads .item.active{background:var(--chip-bg)}
.room{border:1px solid var(--line); border-radius:12px; height:420px; display:flex; flex-direction:column}
.room .msgs{flex:1; overflow:auto; padding:12px}
.msg{margin:8px 0; max-width:80%}
.msg .bubble{padding:10px 12px; border-radius:12px}
.msg.me{margin-left:auto; text-align:right}
.msg.me .bubble{background:var(--info); color:#fff}
.msg.other .bubble{background:var(--chip-bg)}
.room .composer{display:flex; gap:8px; padding:10px; border-top:1px solid var(--line)}
.room .composer input{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:transparent; color:var(--ink)}

/* FOOT */
.footer{color:var(--muted); font-size:13px; text-align:center; margin:28px 0}

/* MOBILE */
@media (max-width:860px){
  .chat{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- NAV -->
<div class="nav">
  <div class="row">
    <div class="pill">
      <button id="btnDrawer" class="btn">‚ò∞ Kategoriler</button>
      <div class="brand">Meditek</div>
    </div>
    <div class="pill" style="gap:8px">
      <div class="switch" id="roleSwitch">
        <button data-role="clinic" class="active">Klinik</button>
        <button data-role="supplier">Tedarik√ßi</button>
      </div>
      <div class="switch" id="themeSwitch">
        <button data-theme="light" class="active">‚òÄÔ∏é</button>
        <button data-theme="dark">üåô</button>
      </div>
    </div>
  </div>
</div>

<!-- FILTER DRAWER -->
<div id="drawer" class="drawer">
  <div class="mask" data-close></div>
  <div class="panel glass">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3>Filtreler</h3><button class="btn" data-close>‚úï</button>
    </div>
    <div class="sub" style="margin-bottom:12px">Kategori, etiket ve arama ile vitrini s√ºz.</div>
    <div class="section">
      <h4>Kategori</h4>
      <div id="filterCats" class="rowv"></div>
    </div>
    <div class="section">
      <h4>Arama</h4>
      <input id="filterQuery" placeholder="Tedarik√ßi, √ºr√ºn, ≈üehir..." style="width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:transparent;color:var(--ink)" />
    </div>
    <div class="section">
      <h4>Etiket</h4>
      <div id="filterTags" class="rowv"></div>
    </div>
    <div class="section" style="display:flex;gap:8px">
      <button id="applyFilters" class="btn primary">Uygula</button>
      <button id="clearFilters" class="btn">Temizle</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- HERO -->
  <div class="glass section">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap">
      <div>
        <h1>Tedarik√ßi Vitrini</h1>
        <div class="sub">≈ûeffaf, hƒ±zlƒ± ve g√ºvenli tedarik aƒüƒ±</div>
      </div>
      <div class="badge ok">üéØ Pilot √ºcretsiz ‚Äì g√ºvenle deneyin</div>
    </div>
  </div>

  <!-- VITRIN -->
  <div class="section">
    <div class="grid cards" id="supplierList"></div>
  </div>

  <!-- PANELS -->
  <div class="section">
    <div class="grid" style="grid-template-columns:1.2fr .8fr; gap:16px">
      <!-- Clinic Panel -->
      <div class="glass">
        <h2>üìå Klinik Paneli</h2>
        <div class="sub" style="margin-bottom:8px">Talep olu≈üturun; tedarik√ßiler teklif versin ve mesajla≈üƒ±n.</div>
        <form id="formRFQ" class="card" style="margin-bottom:12px">
          <div class="title" style="margin-bottom:10px">Yeni Talep (RFQ)</div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
            <input id="rfqProduct" placeholder="√úr√ºn adƒ± (√∂rn. Ultrason)" class="field">
            <select id="rfqCat" class="field">
              <option value="">Kategori</option>
              <option>Tƒ±bbi Cihaz</option><option>Sarf</option><option>Laboratuvar</option><option>G√∂r√ºnt√ºleme</option><option>Veteriner</option><option>G√ºzellik</option>
            </select>
            <input id="rfqQty" type="number" placeholder="Miktar" class="field">
            <input id="rfqDeadline" type="date" class="field">
          </div>
          <input id="rfqNote" placeholder="A√ßƒ±klama (opsiyonel)" class="field" style="margin-top:10px">
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn primary" type="submit">Talep Olu≈ütur</button>
            <button id="btnSeeRFQs" class="btn" type="button">Taleplerim</button>
          </div>
        </form>
        <div id="clinicRFQs" class="grid cards"></div>
      </div>

      <!-- Supplier Panel -->
      <div class="glass">
        <h2>üè≠ Tedarik√ßi Paneli</h2>
        <div class="sub" style="margin-bottom:8px">Uygun RFQ‚Äôlarƒ± g√∂r√ºn, teklif verin, a≈üamalarƒ± ilerletin.</div>
        <form id="formSupplier" class="card" style="margin-bottom:12px">
          <div class="title" style="margin-bottom:10px">Hƒ±zlƒ± Kayƒ±t / G√ºncelle</div>
          <input id="supName" placeholder="≈ûirket adƒ±" class="field">
          <input id="supEmail" placeholder="E-posta" class="field">
          <input id="supCity" placeholder="≈ûehir" class="field">
          <input id="supTags" placeholder="Sertifikalar (CE, ISO, Tƒ∞TUBB, FDA)" class="field">
          <input id="supSpecs" placeholder="Uzmanlƒ±klar (virg√ºlle: Tƒ±bbi Cihaz, G√∂r√ºnt√ºleme‚Ä¶)" class="field">
          <button class="btn primary" type="submit">Kaydet</button>
        </form>
        <div id="supplierRFQs" class="grid cards"></div>
      </div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="section glass">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <h2>üí¨ Mesajlar</h2>
      <span class="sub" id="whoAmI"></span>
    </div>
    <div class="chat" id="chatArea">
      <div class="threads" id="threadList"></div>
      <div class="room">
        <div class="msgs" id="msgs"></div>
        <div class="composer">
          <input id="msgInput" placeholder="Mesaj yazƒ±n‚Ä¶" />
          <button class="btn primary" id="sendMsg">G√∂nder</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="section glass">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>üõ†Ô∏è Admin Paneli</h2>
      <div class="badge muted">Demo veri ‚Äì localStorage</div>
    </div>
    <div class="grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="card"><div class="title">Toplam Talep</div><div id="mStat1" style="font-size:26px;font-weight:800">0</div></div>
      <div class="card"><div class="title">Toplam Teklif</div><div id="mStat2" style="font-size:26px;font-weight:800">0</div></div>
      <div class="card"><div class="title">Tedarik√ßi</div><div id="mStat3" style="font-size:26px;font-weight:800">0</div></div>
      <div class="card"><div class="title">Mesaj</div><div id="mStat4" style="font-size:26px;font-weight:800">0</div></div>
    </div>
    <div class="section">
      <h3>Talepler</h3>
      <table class="table" id="tblRFQ"></table>
    </div>
    <div class="section">
      <h3>Teklifler</h3>
      <table class="table" id="tblOffers"></table>
    </div>
    <div class="section">
      <h3>Mesajlar</h3>
      <table class="table" id="tblMsgs"></table>
    </div>
  </div>

  <div class="footer">¬© Meditek Pilot ‚Äì cam efektli aray√ºz ‚Ä¢ Tema: <span id="themeLabel">A√ßƒ±k</span></div>
</div>

<script>
/* ====== UTIL ====== */
const $=(sel,root=document)=>root.querySelector(sel);
const $$=(sel,root=document)=>[...root.querySelectorAll(sel)];
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);

/* ====== DATA LAYER (localStorage) ====== */
const DB={
  get(key,def){return JSON.parse(localStorage.getItem(key)||JSON.stringify(def))},
  set(key,val){localStorage.setItem(key,JSON.stringify(val))},

  suppliers(){return DB.get('suppliers',[])},
  saveSupplier(s){
    const arr=DB.suppliers();
    const i=arr.findIndex(x=>x.email===s.email);
    if(i>-1) arr[i]={...arr[i],...s}
    else arr.push({...s,id:uid()});
    DB.set('suppliers',arr);
    return arr.find(x=>x.email===s.email);
  },

  rfqs(){return DB.get('rfqs',[])},
  saveRFQ(r){
    const arr=DB.rfqs();
    arr.push({...r,id:uid(),created:Date.now(),status:'open'});
    DB.set('rfqs',arr);
  },
  advanceOffer(ofId){
    const steps=['Ordered','Processing','Dispatched','Delivered'];
    const offs=DB.offers();
    const o=offs.find(x=>x.id===ofId); if(!o) return;
    const idx=steps.indexOf(o.stage||'Ordered');
    o.stage=steps[Math.min(idx+1,steps.length-1)];
    DB.set('offers',offs);
  },

  offers(){return DB.get('offers',[])},
  saveOffer(o){
    const offs=DB.offers();
    offs.push({...o,id:uid(),created:Date.now(),stage:'Ordered'});
    DB.set('offers',offs);
  },

  messages(){return DB.get('messages',[])},
  sendMessage(m){
    const arr=DB.messages();
    arr.push({...m,id:uid(),ts:Date.now()});
    DB.set('messages',arr);
  }
};

/* ====== SEED ====== */
(function seed(){
  if(DB.suppliers().length) return;
  DB.set('suppliers',[
    {id:uid(), name:'MediTech Solutions', email:'meditech@demo.com', city:'ƒ∞stanbul', tags:['CE','ISO'], specs:['Tƒ±bbi Cihaz','G√∂r√ºnt√ºleme']},
    {id:uid(), name:'LabPro', email:'labpro@demo.com', city:'Ankara', tags:['CE'], specs:['Laboratuvar','Sarf']},
    {id:uid(), name:'BeautyTech', email:'beauty@demo.com', city:'ƒ∞zmir', tags:['CE','FDA'], specs:['G√ºzellik','Estetik Cihazlar']}
  ]);
  DB.set('rfqs',[
    {id:uid(), product:'Ultrason Cihazƒ±', cat:'G√∂r√ºnt√ºleme', qty:1, deadline:'2025-09-30', note:'Yetkili satƒ±cƒ± tercih', created:Date.now()-86400000, status:'open', clinic:'Demo Klinik'},
    {id:uid(), product:'Kan Sayƒ±m Kiti', cat:'Laboratuvar', qty:50, deadline:'2025-09-20', note:'Kedi&k√∂pek i√ßin', created:Date.now()-43200000, status:'open', clinic:'Demo Vet'}
  ]);
  const rfq=DB.rfqs()[0]; const sup=DB.suppliers()[0];
  DB.set('messages',[{id:uid(), rfqId:rfq.id, supplierId:sup.id, from:'clinic', text:'Merhaba, demo g√∂r√º≈ümesi.', ts:Date.now()-3600000}]);
})();

/* ====== STATE ====== */
let STATE={
  role:'clinic', // clinic | supplier
  supplierId: DB.suppliers()[0]?.id || null,
  activeThread:null,
  filters:{cats:[], tags:[], q:''}
};

/* ====== THEME ====== */
const setTheme=(t)=>{
  document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
  $('#themeLabel').textContent = t==='dark'?'Koyu':'A√ßƒ±k';
  $$('#themeSwitch button').forEach(b=>b.classList.toggle('active', b.dataset.theme===t));
  localStorage.setItem('theme', t);
};
setTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'));
$('#themeSwitch').addEventListener('click',e=>{
  const b=e.target.closest('button'); if(!b) return;
  setTheme(b.dataset.theme);
});

/* ====== ROLE / PROFILE ====== */
const setRole=(role)=>{
  STATE.role=role;
  $$('#roleSwitch button').forEach(b=>b.classList.toggle('active', b.dataset.role===role));
  const label = role==='clinic' ? 'Klinik profili' :
    `Tedarik√ßi: ${(DB.suppliers().find(s=>s.id===STATE.supplierId)||{}).name||'Se√ßili deƒüil'}`;
  $('#whoAmI').textContent = label;
  renderAll();
};
$('#roleSwitch').addEventListener('click',e=>{
  const b=e.target.closest('button'); if(!b) return;
  setRole(b.dataset.role);
});
setRole(STATE.role);

/* ====== DRAWER (Filters) ====== */
const CATS=['Tƒ±bbi Cihaz','Sarf','Laboratuvar','G√∂r√ºnt√ºleme','Veteriner','G√ºzellik'];
const TAGS=['CE','ISO','Tƒ∞TUBB','FDA'];

const drawChips=(arr, el, active=[])=>{
  el.innerHTML='';
  arr.forEach(x=>{
    const b=document.createElement('button');
    b.className='chip'; b.textContent=x;
    if(active.includes(x)) b.style.outline='2px solid var(--ink)';
    b.addEventListener('click',()=>{
      if(active.includes(x)) active.splice(active.indexOf(x),1);
      else active.push(x);
      drawChips(arr,el,active);
    });
    el.appendChild(b);
  });
  return active;
};
STATE.filters.cats = drawChips(CATS, $('#filterCats'), STATE.filters.cats);
STATE.filters.tags = drawChips(TAGS, $('#filterTags'), STATE.filters.tags);

const openDrawer=()=>$('#drawer').classList.add('on');
const closeDrawer=()=>$('#drawer').classList.remove('on');
$('#btnDrawer').onclick=openDrawer;
$$('[data-close]').forEach(x=>x.onclick=closeDrawer);

$('#applyFilters').onclick=()=>{
  STATE.filters.q = $('#filterQuery').value.trim().toLowerCase();
  closeDrawer(); renderVitrine();
};
$('#clearFilters').onclick=()=>{
  STATE.filters={cats:[], tags:[], q:''};
  $('#filterQuery').value='';
  STATE.filters.cats = drawChips(CATS, $('#filterCats'), STATE.filters.cats);
  STATE.filters.tags = drawChips(TAGS, $('#filterTags'), STATE.filters.tags);
  renderVitrine();
};

/* ====== VITRINE ====== */
function renderVitrine(){
  const box=$('#supplierList'); box.innerHTML='';
  let list=DB.suppliers();

  // filters
  if(STATE.filters.cats.length){
    list=list.filter(s=>s.specs?.some(sp=>STATE.filters.cats.includes(sp)));
  }
  if(STATE.filters.tags.length){
    list=list.filter(s=>s.tags?.some(t=>STATE.filters.tags.includes(t)));
  }
  if(STATE.filters.q){
    list=list.filter(s=>(s.name+s.city+s.email+(s.specs||[]).join()+ (s.tags||[]).join()).toLowerCase().includes(STATE.filters.q))
  }

  if(!list.length){
    box.innerHTML=`<div class="glass"><div class="sub">Filtrelere uygun tedarik√ßi bulunamadƒ±.</div></div>`;
    return;
  }

  list.forEach(s=>{
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <div>${s.name}</div>
        <span class="badge muted">${s.city||'‚Äî'}</span>
      </div>
      <div class="meta">
        ${(s.specs||[]).map(x=>`<span class="chip">${x}</span>`).join('')}
      </div>
      <div class="meta">
        ${(s.tags||[]).map(x=>`<span class="chip">${x}</span>`).join('')}
      </div>
      <div class="sub" style="margin:8px 0">üí° √ñr. Ultrason 150‚Äì500 bin TL</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" data-act="rfq">RFQ Olu≈ütur</button>
        <button class="btn" data-act="msg">Mesaj G√∂nder</button>
      </div>
    `;
    card.querySelector('[data-act="rfq"]').onclick=()=>{
      // √∂n doldurma
      $('#rfqProduct').value='Ultrason Cihazƒ±';
      $('#rfqCat').value='G√∂r√ºnt√ºleme';
      $('html,body'); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    };
    card.querySelector('[data-act="msg"]').onclick=()=>{
      STATE.role='clinic'; setRole('clinic');
      openChatThread(findOrCreateThread(DB.rfqs()[0]?.id, s.id));
    };
    box.appendChild(card);
  });
}

/* ====== CLINIC PANEL ====== */
const fieldStyle=`
  .field{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:transparent; color:var(--ink)}
`; const style=document.createElement('style'); style.innerHTML=fieldStyle; document.head.appendChild(style);

$('#formRFQ').addEventListener('submit',e=>{
  e.preventDefault();
  const r={
    product:$('#rfqProduct').value.trim(),
    cat:$('#rfqCat').value.trim(),
    qty:+$('#rfqQty').value||1,
    deadline:$('#rfqDeadline').value,
    note:$('#rfqNote').value.trim(),
    clinic:'Klinik (Pilot)'
  };
  if(!r.product||!r.cat||!r.deadline){alert('√úr√ºn, kategori ve termin zorunlu.'); return}
  DB.saveRFQ(r); e.target.reset();
  renderClinicRFQs(); renderAdmin(); alert('Talep eklendi.');
});

$('#btnSeeRFQs').onclick=()=>renderClinicRFQs();

function renderClinicRFQs(){
  const box=$('#clinicRFQs'); const rfqs=DB.rfqs().slice().reverse();
  box.innerHTML = rfqs.map(r=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between">
        <div class="title">${r.product}</div>
        <span class="badge ${r.status==='open'?'info':'ok'}">${r.status}</span>
      </div>
      <div class="meta"><span class="chip">${r.cat}</span><span class="chip">${r.qty} adet</span><span class="chip">Termin: ${r.deadline}</span></div>
      <div class="sub">${r.note||''}</div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" data-view="${r.id}">Teklifler</button>
      </div>
    </div>
  `).join('');

  $$('#clinicRFQs [data-view]').forEach(b=>{
    b.onclick=()=>openOffersFor(b.dataset.view);
  });
}

/* ====== SUPPLIER PANEL ====== */
$('#formSupplier').addEventListener('submit',e=>{
  e.preventDefault();
  const sup={
    name:$('#supName').value.trim()||'Yeni Tedarik√ßi',
    email:$('#supEmail').value.trim()||`sup${Math.floor(Math.random()*999)}@demo.com`,
    city:$('#supCity').value.trim(),
    tags: $('#supTags').value.split(',').map(x=>x.trim()).filter(Boolean),
    specs: $('#supSpecs').value.split(',').map(x=>x.trim()).filter(Boolean)
  };
  const saved=DB.saveSupplier(sup);
  STATE.supplierId=saved.id; setRole('supplier');
  alert('Tedarik√ßi kaydƒ± g√ºncellendi.');
});

function renderSupplierRFQs(){
  const box=$('#supplierRFQs'); const me=DB.suppliers().find(s=>s.id===STATE.supplierId);
  if(!me){box.innerHTML='<div class="card sub">√ñnce saƒü √ºstten tedarik√ßi profili se√ßin / kaydedin.</div>'; return}
  let rfqs=DB.rfqs().filter(r=> me.specs?.includes(r.cat) || me.specs?.some(x=>r.product.toLowerCase().includes(x.toLowerCase())));
  if(!rfqs.length){box.innerHTML='<div class="card sub">Uzmanlƒ±ƒüƒ±nƒ±za uygun a√ßƒ±k talep bulunamadƒ±.</div>'; return}
  box.innerHTML = rfqs.slice().reverse().map(r=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between">
        <div class="title">${r.product}</div>
        <span class="badge info">open</span>
      </div>
      <div class="meta"><span class="chip">${r.cat}</span><span class="chip">${r.qty} adet</span></div>
      <div class="sub">Termin: ${r.deadline}</div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" data-offer="${r.id}">Teklif Ver</button>
        <button class="btn" data-chat="${r.id}">Mesaj A√ß</button>
      </div>
    </div>
  `).join('');
  $$('#supplierRFQs [data-offer]').forEach(b=>{
    b.onclick=()=>{
      const price=prompt('Teklif fiyatƒ± (TL)'); if(!price) return;
      DB.saveOffer({rfqId:b.dataset.offer, supplierId:STATE.supplierId, price:+price});
      renderAdmin(); alert('Teklif g√∂nderildi.');
    };
  });
  $$('#supplierRFQs [data-chat]').forEach(b=>{
    b.onclick=()=>{
      openChatThread(findOrCreateThread(b.dataset.chat, STATE.supplierId));
    };
  });
}

/* ====== OFFERS VIEW (clinic side) ====== */
function openOffersFor(rfqId){
  const offs=DB.offers().filter(o=>o.rfqId===rfqId);
  if(!offs.length){alert('Bu talepte hen√ºz teklif yok.'); return}
  const txt=offs.map(o=>{
    const s=DB.suppliers().find(x=>x.id===o.supplierId);
    return `${s?.name||'Tedarik√ßi'} ‚Ä¢ ${o.price.toLocaleString()} TL ‚Ä¢ A≈üama: ${o.stage}`;
  }).join('\n');
  alert('Gelen teklifler:\n\n'+txt+'\n\nAdmin panelinden detay/ilerletme yapabilirsiniz.');
}

/* ====== CHAT ====== */
function threadKey(rfqId, supplierId){ return `${rfqId}__${supplierId}` }
function listThreads(role){
  const msgs=DB.messages();
  const map=new Map();
  msgs.forEach(m=>{
    const key=threadKey(m.rfqId,m.supplierId);
    const arr=map.get(key)||[];
    arr.push(m); map.set(key,arr);
  });
  // include empty threads from offers too
  DB.offers().forEach(o=>{
    const key=threadKey(o.rfqId,o.supplierId); if(!map.has(key)) map.set(key,[]);
  });

  // role filter
  return [...map.entries()].filter(([key,arr])=>{
    const [rfqId,supplierId]=key.split('__');
    if(role==='clinic') return true;
    return supplierId===STATE.supplierId;
  }).map(([key,arr])=>{
    const [rfqId,supplierId]=key.split('__');
    const rfq=DB.rfqs().find(r=>r.id===rfqId);
    const sup=DB.suppliers().find(s=>s.id===supplierId);
    return {id:key, rfq, sup, last:arr.slice(-1)[0]};
  }).sort((a,b)=>(b.last?.ts||0)-(a.last?.ts||0));
}
function findOrCreateThread(rfqId,supplierId){
  return threadKey(rfqId,supplierId);
}
function openChatThread(key){
  STATE.activeThread=key;
  renderThreads(); renderMessages();
}
function renderThreads(){
  const list=listThreads(STATE.role);
  const box=$('#threadList'); box.innerHTML='';
  if(!list.length){ box.innerHTML=`<div class="item sub">Hen√ºz sohbet yok</div>`; return}
  list.forEach(t=>{
    const el=document.createElement('div'); el.className='item'+(STATE.activeThread===t.id?' active':'');
    el.innerHTML=`<div style="font-weight:700">${t.sup?.name||'Tedarik√ßi'}</div>
      <div class="sub" style="font-size:12px">${t.rfq?.product||'RFQ'}${t.last? ' ‚Äî '+t.last.text.slice(0,28):''}</div>`;
    el.onclick=()=>openChatThread(t.id);
    box.appendChild(el);
  });
  if(!STATE.activeThread && list[0]) STATE.activeThread=list[0].id;
}
function renderMessages(){
  const msgs=DB.messages();
  const box=$('#msgs'); box.innerHTML='';
  if(!STATE.activeThread) return;
  const [rfqId, supplierId]=STATE.activeThread.split('__');
  const rfq=DB.rfqs().find(r=>r.id===rfqId);
  const sup=DB.suppliers().find(s=>s.id===supplierId);
  const arr=msgs.filter(m=>m.rfqId===rfqId && m.supplierId===supplierId);
  if(rfq) box.insertAdjacentHTML('beforeend', `<div class="sub" style="margin-bottom:6px">Konu: <b>${rfq.product}</b> ‚Äì ${sup?.name||''}</div>`);
  arr.forEach(m=>{
    const me = (STATE.role==='supplier' ? 'supplier':'clinic') === m.from;
    const div=document.createElement('div'); div.className='msg '+(me?'me':'other');
    div.innerHTML=`<div class="bubble">${m.text}</div><div class="sub" style="font-size:11px">${new Date(m.ts).toLocaleString()}</div>`;
    box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
}
$('#sendMsg').onclick=()=>{
  if(!STATE.activeThread){alert('Sohbet se√ßin.'); return}
  const val=$('#msgInput').value.trim(); if(!val) return;
  const from = STATE.role==='supplier'?'supplier':'clinic';
  const [rfqId,supplierId]=STATE.activeThread.split('__');
  DB.sendMessage({rfqId, supplierId, from, text:val});
  $('#msgInput').value=''; renderMessages(); renderAdmin();
};

/* ====== ADMIN ====== */
function renderAdmin(){
  $('#mStat1').textContent=DB.rfqs().length;
  $('#mStat2').textContent=DB.offers().length;
  $('#mStat3').textContent=DB.suppliers().length;
  $('#mStat4').textContent=DB.messages().length;

  const rfqHead=`<tr><th>ID</th><th>√úr√ºn</th><th>Kat.</th><th>Qty</th><th>Termin</th><th>Durum</th></tr>`;
  $('#tblRFQ').innerHTML = rfqHead + DB.rfqs().slice().reverse().map(r=>
    `<tr><td>${r.id.slice(-6)}</td><td>${r.product}</td><td>${r.cat}</td><td>${r.qty}</td><td>${r.deadline}</td><td>${r.status}</td></tr>`
  ).join('');

  const offHead=`<tr><th>ID</th><th>RFQ</th><th>Tedarik√ßi</th><th>Fiyat</th><th>A≈üama</th><th>Aksiyon</th></tr>`;
  $('#tblOffers').innerHTML = offHead + DB.offers().slice().reverse().map(o=>{
    const r=DB.rfqs().find(x=>x.id===o.rfqId); const s=DB.suppliers().find(x=>x.id===o.supplierId);
    return `<tr><td>${o.id.slice(-6)}</td><td>${r?.product||'-'}</td><td>${s?.name||'-'}</td><td>${(o.price||0).toLocaleString()} TL</td>
      <td>${o.stage}</td><td><button class="btn" data-adv="${o.id}">Sonraki A≈üama</button></td></tr>`;
  }).join('');
  $$('#tblOffers [data-adv]').forEach(b=>{
    b.onclick=()=>{DB.advanceOffer(b.dataset.adv); renderAdmin(); alert('A≈üama g√ºncellendi.');}
  });

  const msgHead=`<tr><th>Zaman</th><th>RFQ</th><th>Tedarik√ßi</th><th>Kimden</th><th>Mesaj</th></tr>`;
  $('#tblMsgs').innerHTML = msgHead + DB.messages().slice().reverse().map(m=>{
    const r=DB.rfqs().find(x=>x.id===m.rfqId); const s=DB.suppliers().find(x=>x.id===m.supplierId);
    return `<tr><td>${new Date(m.ts).toLocaleString()}</td><td>${r?.product||'-'}</td><td>${s?.name||'-'}</td><td>${m.from}</td><td>${m.text}</td></tr>`;
  }).join('');
}

/* ====== RENDER ALL ====== */
function renderAll(){
  renderVitrine();
  renderClinicRFQs();
  renderSupplierRFQs();
  renderThreads(); renderMessages();
  renderAdmin();
}
renderAll();
</script>
</body>
</html>
