<!doctype html> 
<!--
  This is the updated Meditek pilot application.  It refactors the original single
  page into a richer experience based on the latest requirements.  Major
  additions include:
  • A role selection on the home page that stores the chosen role in
    localStorage and routes the user directly to the Clinic or Supplier panel.
  • Category blocks on the home page that offer quick access to template
    information for clinics and document requirements for suppliers.  These
    categories are clickable and pre‑select the category when creating new
    requests.
  • Two new pages: a Demo centre (#demo) which showcases example RFQs and
    bids separated from real data, and a Trust & Compliance page (#trust)
    outlining regulatory adherence (CE, ISO 13485, ÜTS/TİTUBB, KVKK).  The
    navigation bar has been extended accordingly.
  • Additional fields in the supplier profile for tax number, MERSİS, CE/ISO
    document uploads and ÜTS/TİTUBB link.  A rosette system (pending,
    pre‑approved, approved) reflects how complete the documentation is.
  • An updated supply chain flow where only the supplier associated with the
    selected bid can progress the order through stages (Ordered → Processing
    → Dispatched → Delivered).  Clinics may only observe and confirm
    delivery once completed.  Admin can override via the admin page.
  • Contact information for suppliers remains hidden on received bids until a
    clinic formally selects a bid, preventing off‑platform negotiations in
    early stages.
  • Minor enhancements: a simple guide for first time clinics, a button to
    launch the demo page, average statistics calculations, and improved
    internationalisation keys.
  The application continues to rely solely on localStorage for persistence
  in this pilot phase.  See the script section for detailed implementation.
-->
<html lang="tr" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Meditek — Pilot Geliştirilmiş</title>

<!-- UI libs -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/@lottiefiles/lottie-player@2.0.4/dist/tgs-player.js"></script>

<style>
/*
  The style definitions below extend the original design.  New classes
  introduced include role‑selection and category grids on the home page,
  rosette badges for supplier verification status, a trust/notice band and
  styling tweaks for the demo centre.  Dark mode support is retained.
*/
:root{
  --ink:#0F172A; --mut:#64748B; --bg:#FFFFFF; --glass:#FFFFFFCC;
  --stroke:#E5E7EB; --shadow:0 18px 40px rgba(15,23,42,0.08);
  --ok:#10B981; --warn:#F59E0B; --err:#EF4444;
  --chip:#F3F4F6; --cardbg:rgba(255,255,255,0.85);
}
:root[data-theme="dark"]{
  --ink:#E5E7EB; --mut:#9CA3AF; --bg:#0B1220; --glass:#0F172ACC;
  --stroke:#1F2937; --shadow:0 18px 40px rgba(0,0,0,0.35);
  --chip:#111827; --cardbg:rgba(17,24,39,0.75);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 80% -10%, #F3F4F6 0%, transparent 60%),
    radial-gradient(1000px 500px at -10% 0%, #F8FAFC 0%, transparent 60%),
    var(--bg);
}

/* NAV (cam) */
.navbar{
  background:var(--glass);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border:1px solid rgba(255,255,255,0.6);
  border-bottom:1px solid rgba(15,23,42,0.06);
  box-shadow:var(--shadow);
  border-radius:16px;
  padding:10px 18px;
  margin:16px auto 0;
  width: min(1100px, 94%);
}
.navbar .navbar-brand{ font-weight:800; letter-spacing:-0.02em; }
.navbar .nav-link{ color:var(--mut)!important; border-radius:999px; padding:.45rem .9rem; font-weight:600; }
.navbar .nav-link:hover,.navbar .nav-link.active{ color:var(--ink)!important; background:#F3F4F6; }
:root[data-theme="dark"] .navbar .nav-link:hover,
:root[data-theme="dark"] .navbar .nav-link.active{ background:#111827; }

/* Hero – cam + gradient */
.hero{
  margin-top:110px;
  width:min(1100px,94%); margin-inline:auto;
  border-radius:24px; overflow:hidden; position:relative;
  background:
    linear-gradient(135deg, rgba(243,244,246,.95), rgba(255,255,255,.75)),
    url('https://images.unsplash.com/photo-1559757148-5c350d0d3c56?auto=format&fit=crop&w=2000&q=80') center/cover;
  box-shadow:var(--shadow);
  border:1px solid rgba(255,255,255,.65);
}
:root[data-theme="dark"] .hero{
  background:
    linear-gradient(135deg, rgba(17,24,39,.8), rgba(31,41,55,.5)),
    url('https://images.unsplash.com/photo-1559757148-5c350d0d3c56?auto=format&fit=crop&w=2000&q=80') center/cover;
}
.hero-inner{
  backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
  padding:28px;
}
.hero h1{
  font-weight:800;
  letter-spacing:-0.02em;
  margin:0 0 12px;
  font-size:2.2rem;
  line-height:1.2;
}
.hero p{
  color:var(--mut);
  margin:0 0 20px;
  font-size:1.1rem;
  line-height:1.5;
}

/* Role selection buttons */
.role-select{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
.role-select .btnx{
  flex:1;
  padding:.8rem 1.2rem;
  font-size:1rem;
}

/* Category blocks on home */
.categories{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; margin-top:28px; }
.cat-card{
  background:var(--cardbg);
  border:1px solid var(--stroke);
  border-radius:20px;
  padding:22px;
  text-align:center;
  cursor:pointer;
  /* subtle shadow for depth */
  box-shadow:0 8px 16px rgba(15,23,42,0.05);
  transition:transform .12s ease, box-shadow .12s ease;
}
.cat-card:hover{ transform:translateY(-3px); box-shadow:0 10px 20px rgba(15,23,42,0.15); }
.cat-card i{ font-size:1.6rem; margin-bottom:8px; color:var(--ok); }
.cat-card .cat-name{ font-weight:700; }

/* Trust band */
.trust-band{
  display:flex;
  gap:.6rem;
  align-items:center;
  background:var(--cardbg);
  border:1px solid var(--stroke);
  padding:.6rem 1rem;
  border-radius:999px;
  margin-top:18px;
  box-shadow:0 8px 24px rgba(0,0,0,0.04);
  font-size:0.9rem;
}

/* Sayfa iskeleti */
.page{display:none;min-height:100vh;padding:60px 0 80px}
.page.active{display:block}

/* Kart */
.cardx{
  background:var(--glass);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border:1px solid rgba(255,255,255,0.65);
  outline:1px solid rgba(15,23,42,0.06);
  border-radius:24px;
  box-shadow:0 12px 28px rgba(15,23,42,0.08);
  padding:28px;
  margin-bottom:32px;
}

/* Başlıklar */
h1,h2,h3,h4,h5{letter-spacing:-0.02em}
h1{font-weight:800}
.section-note{color:var(--mut)}

/* Butonlar – animasyonlu */
.btnx{
  background:var(--ink); color:#fff; border:0; border-radius:999px;
  padding:12px 20px; font-weight:800; letter-spacing:-0.01em;
  box-shadow:0 8px 20px rgba(15,23,42,0.12);
  transition:transform .14s ease, box-shadow .22s ease, background .22s ease;
}
.btnx:hover{ transform:translateY(-2px) scale(1.03); box-shadow:0 16px 36px rgba(15,23,42,0.18); }
.btnx:active{ transform:translateY(0) scale(.99); }
.btnx.alt{ background:transparent; color:var(--ink); border:1px solid var(--stroke); }
.btnx.alt:hover{background:#F3F4F6}
:root[data-theme="dark"] .btnx.alt:hover{ background:#111827 }

/* Form – focus ışığı */
.form-control,.form-select{
  border-radius:999px!important;
  border:1px solid var(--stroke)!important;
  background:rgba(255,255,255,0.9);
  padding:.8rem 1rem; transition: box-shadow .2s ease, border-color .2s ease;
  color: var(--ink);
}
:root[data-theme="dark"] .form-control, :root[data-theme="dark"] .form-select{
  background:#0B1220;
  color: var(--ink);
}
.form-control:focus,.form-select:focus{
  border-color:#CBD5E1!important;
  box-shadow:0 0 0 6px rgba(203,213,225,0.35)!important;
  outline:0;
}

/* Chip / Tag */
.badge-chip{
  /* Enhanced badge styling for a more professional look */
  display:inline-block;
  padding:.45rem 1rem;
  border-radius:20px;
  background:var(--chip);
  color:var(--ink);
  font-weight:600;
  border:1px solid var(--stroke);
  box-shadow:0 2px 4px rgba(15,23,42,0.08);
  margin-right:.35rem;
  transition:transform .1s ease;
}
.badge-chip:hover{
  transform:translateY(-2px);
}
.tag{display:inline-block;border:1px solid var(--stroke);border-radius:999px;padding:.18rem .6rem;margin-right:.25rem;color:var(--ink);font-weight:600}

/* Tablo modernizasyonu + kart görünümü */
.table thead th{ background:#0F172A; color:#fff; border:0; font-weight:700; letter-spacing:0; }
:root[data-theme="dark"] .table thead th{ background:#111827 }
.table{ border-radius:14px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
.table > :not(caption) > * > *{ background:var(--cardbg) }
.table tbody tr:hover{ background:#F8FAFC }
:root[data-theme="dark"] .table tbody tr:hover{ background:#0B1220 }

/* Responsive kart listesi */
.card-list{ display:none; }
@media (max-width: 768px){
  .table-wrap{ display:none; }
  .card-list{ display:grid; gap:12px; }
  .item-card{
    border:1px solid var(--stroke); border-radius:16px; background:var(--cardbg); padding:12px;
  }
}

/* Toast */
.toast-wrap{position:fixed;top:18px;right:18px;z-index:9999;max-width:440px}
.toastx{ display:flex; gap:.6rem; background:rgba(255,255,255,0.95);
  border:1px solid var(--stroke); border-radius:16px; padding:12px; margin-bottom:10px; box-shadow:var(--shadow) }
:root[data-theme="dark"] .toastx{ background:#0F172A }
.toastx.success{border-left:6px solid var(--ok)}
.toastx.error{border-left:6px solid var(--err)}
.toastx.info{border-left:6px solid #111827}

/* Pilot banner */
.pilot-box{
  display:flex; gap:1rem; align-items:flex-start;
  background:var(--cardbg); border:1px solid var(--stroke); border-radius:16px;
  padding:1.25rem; box-shadow:0 8px 24px rgba(0,0,0,0.04)
}
.pilot-box i{font-size:1.6rem; color:#111827; margin-top:.2rem}
:root[data-theme="dark"] .pilot-box i{ color:#E5E7EB }

/* Boş durum */
.empty{padding:20px;border:1px dashed var(--stroke);border-radius:16px;color:var(--mut);text-align:center}

/* Mesaj kartları (Apple Notes tarzı) */
.msg-card{
  background:var(--cardbg); border:1px solid var(--stroke); border-radius:16px; padding:12px 14px; margin-bottom:12px;
}

/* Stepper */
.stepper{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
.step{ padding:.25rem .6rem; border-radius:999px; border:1px solid var(--stroke); font-weight:700; color:var(--mut) }
.step.active{ background:#0F172A; color:#fff; border-color:#0F172A }
:root[data-theme="dark"] .step.active{ background:#111827; border-color:#111827 }

/* Mini stat kartları */
.stat-mini{
  display:flex; gap:10px; align-items:center; background:var(--cardbg); border:1px solid var(--stroke);
  border-radius:16px; padding:10px 12px;
}

/* Küçük yardımcı sınıflar */
.smallmut{color:var(--mut)}
.w-1100{ max-width:1100px }

/* Dil/Karanlık mod buton grubu */
.top-controls{ display:flex; gap:8px; align-items:center }
.toggle{ border:1px solid var(--stroke); background:var(--cardbg); border-radius:999px; padding:.25rem .6rem; cursor:pointer; user-select:none }
.toggle.active{ font-weight:800 }

/* Supply chain durumları */
.supply-status{
  font-size:0.85rem;
  margin-top:4px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.supply-status .stage{
  padding:.15rem .5rem;
  border-radius:999px;
  border:1px solid var(--stroke);
  font-weight:600;
  font-size:0.75rem;
  color:var(--ink);
  background:var(--chip);
}
.supply-status .stage.current{
  background:var(--ok);
  color:#fff;
  border-color:var(--ok);
}

/* Rosette badges */
.rozet-badge{
  padding:.3rem .7rem;
  border-radius:999px;
  font-weight:700;
  display:inline-block;
  margin-left:.4rem;
  font-size:0.75rem;
}
.rozet-pending{ background:#FDE68A; color:#92400E; }
.rozet-partial{ background:#BFDBFE; color:#1E3A8A; }
.rozet-full{ background:#A7F3D0; color:#065F46; }

/* Demo page styles */
.demo-stats{ display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem; }
.demo-stat{
  flex:1;
  background:var(--cardbg);
  border:1px solid var(--stroke);
  border-radius:16px;
  padding:1rem;
  text-align:center;
  box-shadow:0 6px 14px rgba(0,0,0,0.05);
}
.demo-stat h6{ margin:0; font-weight:700; font-size:1.1rem; }
.demo-stat .big{ font-weight:800; font-size:1.6rem; color:var(--ink); margin-top:.3rem; }

/* Top support bar */
.support-bar{
  position:fixed;
  top:0;
  width:100%;
  z-index:999;
  text-align:center;
  background:var(--ink);
  /* ensure contact bar text contrasts in both light and dark themes */
  color:var(--bg);
  padding:.4rem .8rem;
  font-size:.85rem;
}
.support-bar a{
  color:var(--bg);
  text-decoration:underline;
}
</style>
</head>
<body>

<!-- Support Bar -->
<div class="support-bar">
  <span data-i18n="supportMsg">5 dk içinde dönüş: WhatsApp Business +90 XXX XXX XX XX</span>
  <span class="d-none d-md-inline"> | </span>
  <span class="d-none d-md-inline"><a href="mailto:kadirmanay58@gmail.com">E-posta</a></span>
</div>

<!-- NAV -->
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container-fluid px-2">
    <a class="navbar-brand" href="#home"><i class="fa-solid fa-heartbeat"></i> Meditek <span class="badge text-bg-dark">Pilot</span></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto gap-2">
        <li class="nav-item"><a class="nav-link" href="#clinic" data-i18n="navClinic">Klinik</a></li>
        <li class="nav-item"><a class="nav-link" href="#supplier" data-i18n="navSupplier">Tedarikçi</a></li>
        <li class="nav-item"><a class="nav-link" href="#requests" data-i18n="navRequests">Açık Talepler</a></li>
        <li class="nav-item"><a class="nav-link" href="#demo" data-i18n="navDemo">Demo</a></li>
        <li class="nav-item"><a class="nav-link" href="#admin" data-i18n="navAdmin">Admin</a></li>
        <li class="nav-item"><a class="nav-link" href="#trust" data-i18n="navTrust">Güven &amp; Uyum</a></li>
      </ul>
      <div class="ms-lg-3 top-controls">
        <span class="toggle" id="langTR">TR</span><span class="toggle" id="langEN">EN</span>
        <span class="toggle" id="darkToggle"><i class="fa-regular fa-moon"></i></span>
      </div>
    </div>
  </div>
</nav>

<!-- HERO -->
<div class="hero">
  <div class="hero-inner">
    <h1 data-i18n="heroTitle">Şeffaf Teklif. Hızlı Karar.</h1>
    <p data-i18n="heroSub">Klinik talep açar → Tedarikçi listeden görüp <b>Teklif Ver</b>ir → Teklif kliniğin <b>Mesajlar</b> bölümüne düşer. Pilot: localStorage + e-posta.</p>
    <!-- Role selection for home page -->
    <div class="role-select">
      <button class="btnx" id="btnClinicRole" data-i18n="heroRole1">🏥 Klinik için devam et</button>
      <button class="btnx alt" id="btnSupplierRole" data-i18n="heroRole2">🚚 Tedarikçi için devam et</button>
    </div>
    <div class="mt-3">
      <span class="badge-chip">48 saat çoklu teklif</span>
      <span class="badge-chip">+%20 tasarruf</span>
      <span class="badge-chip">Reverse marketplace</span>
    </div>
    <!-- Trust band emphasises regulatory compliance -->
    <div class="trust-band" data-i18n="trustBand">CE • ISO 13485 • ÜTS/TİTUBB • KVKK — Meditek aracı platformdur, ticari sorumluluk taraflardadır.</div>
  </div>
</div>

<!-- PAGES -->
<section id="home" class="page active">
  <div class="container w-1100">
    <div class="row g-4 mt-3">
      <div class="col-12">
        <div class="pilot-box">
          <i class="fas fa-check-circle"></i>
          <div>
            <h5 class="mb-1" data-i18n="pilotTitle">Pilot Uygulama — Ücretsiz</h5>
            <p class="mb-0" data-i18n="pilotText">Meditek şu an <b>pilot</b> aşamada. Klinikler ve tedarikçiler için sistem <b>ücretsiz</b>. Geri bildirimler deneyimi iyileştirir.</p>
          </div>
        </div>
        <!-- Home categories grid -->
        <h5 class="mt-4" data-i18n="homeGuideTitle">Klinikler için kategorilere göre şablonlar</h5>
        <p class="section-note" data-i18n="homeGuideDesc">Taleplerinizi hızla oluşturmak için kategori seçin ve hazır şablonları kullanın.</p>
        <div class="categories">
          <div class="cat-card" data-cat="Sarf Malzeme" onclick="handleCategoryClick('Sarf Malzeme')">
            <i class="fa-solid fa-boxes-stacked"></i>
            <div class="cat-name" data-i18n="catSarf">Sarf Malzeme</div>
          </div>
          <div class="cat-card" data-cat="Medikal Cihaz" onclick="handleCategoryClick('Medikal Cihaz')">
            <i class="fa-solid fa-stethoscope"></i>
            <div class="cat-name" data-i18n="catCihaz">Medikal Cihaz</div>
          </div>
          <div class="cat-card" data-cat="Laboratuvar" onclick="handleCategoryClick('Laboratuvar')">
            <i class="fa-solid fa-vials"></i>
            <div class="cat-name" data-i18n="catLab">Laboratuvar</div>
          </div>
          <div class="cat-card" data-cat="Radyoloji" onclick="handleCategoryClick('Radyoloji')">
            <i class="fa-solid fa-x-ray"></i>
            <div class="cat-name" data-i18n="catRad">Radyoloji</div>
          </div>
          <div class="cat-card" data-cat="Diş Sağlığı" onclick="handleCategoryClick('Diş Sağlığı')">
            <i class="fa-solid fa-tooth"></i>
            <div class="cat-name" data-i18n="catDis">Diş Sağlığı</div>
          </div>
          <div class="cat-card" data-cat="Hizmet" onclick="handleCategoryClick('Hizmet')">
            <i class="fa-solid fa-handshake"></i>
            <div class="cat-name" data-i18n="catHizmet">Hizmet</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- CLINIC -->
<section id="clinic" class="page">
  <div class="container w-1100">
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="cardx">
          <h3 class="mb-2"><i class="fa-solid fa-hospital"></i> <span data-i18n="clinicProfile">Klinik Profili</span></h3>
          <p class="section-note" data-i18n="profileKey">E-posta profil anahtarındır. Aynı e-posta ile giriş yaparsan kayıtların yüklenir.</p>
          <form id="clinicProfileForm">
            <div class="mb-2"><label class="form-label" data-i18n="labOrg">Klinik/Hastane</label><input class="form-control" name="org" required></div>
            <div class="row">
              <div class="col-md-6 mb-2"><label class="form-label" data-i18n="labAuth">Yetkili</label><input class="form-control" name="name" required></div>
              <div class="col-md-6 mb-2"><label class="form-label" data-i18n="labPhone">Telefon</label><input class="form-control" name="phone" required></div>
            </div>
            <div class="mb-2"><label class="form-label" data-i18n="labGroup">Grup (çoklu klinik yönetimi)</label><input class="form-control" name="group" placeholder="örn. Grup A"></div>
            <div class="mb-3"><label class="form-label" data-i18n="labEmail">E-posta (profil anahtarı)</label><input class="form-control" type="email" name="email" required></div>
            <button class="btnx w-100" type="submit" data-i18n="btnSaveLoad">Profili Kaydet / Yükle</button>
          </form>
          <div id="clinicProfileInfo" class="mt-3 section-note"></div>
        </div>
        <!-- First time guide -->
        <div class="cardx">
          <h5 class="mb-2">🆘 <span data-i18n="firstGuide">İlk Talebimi Nasıl Açarım?</span></h5>
          <p class="section-note" data-i18n="firstGuideDesc">Kategori seçin, hazır şablonu doldurun ve Talebi Yayınla butonuna tıklayın. Aşağıdaki kısa video size yol gösterecek.</p>
          <!-- Removed YouTube video to streamline the page -->
          <button class="btnx w-100 mt-2" onclick="showPage('demo')" data-i18n="demoLink">Demo RFQ oluştur</button>
        </div>
        <div class="cardx">
          <div class="stepper">
            <span class="step" id="st1">1. Detay</span>
            <span class="step" id="st2">2. Miktar</span>
            <span class="step" id="st3">3. Termin</span>
            <span class="step" id="st4">4. Onay</span>
          </div>
          <h4 class="mb-2" data-i18n="createReq">📝 Talep Oluştur</h4>
          <form id="clinicRequestForm">
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label" data-i18n="labCat">Kategori</label>
                <select class="form-select" name="kategori" required>
                  <option>Medikal Cihaz</option><option>Sarf Malzeme</option>
                  <option>Ameliyat Malzemesi</option><option>Laboratuvar</option>
                  <option>Radyoloji</option><option>Diş Sağlığı</option><option>Hizmet</option><option>Diğer</option>
                </select>
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label" data-i18n="labTermin">Beklenen Termin</label>
                <input class="form-control" type="date" name="termin" required>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label" data-i18n="labDesc">Ürün Açıklaması</label>
              <textarea class="form-control" name="urun" rows="3" placeholder="örn. 10 adet hasta monitörü, CE, 2 yıl garanti" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3"><label class="form-label" data-i18n="labQty">Miktar</label><input class="form-control" type="number" name="miktar" min="1" required></div>
              <div class="col-md-4 mb-3"><label class="form-label" data-i18n="labUnit">Birim</label>
                <select class="form-select" name="birim"><option>Adet</option><option>Kutu</option><option>Paket</option><option>Kilogram</option><option>Litre</option></select>
              </div>
              <div class="col-md-4 mb-3"><label class="form-label">Görsel/Şartname (PDF)</label><input class="form-control" type="file" accept=".pdf,image/*" name="file"></div>
            </div>
            <div class="mb-2">
              <label class="form-label" data-i18n="labIot">IoT Entegrasyonu</label>
              <select class="form-select" name="iot">
                <option value="No" selected>Hayır</option>
                <option value="Yes">Evet</option>
              </select>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Görünürlük</label>
                <select class="form-select" name="vis">
                  <option value="public">Herkese Açık</option>
                  <option value="private">Özel (davet linki)</option>
                </select>
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Durum</label>
                <select class="form-select" name="status">
                  <option value="open">Açık</option>
                  <option value="selected">Seçildi</option>
                  <option value="closed">Kapalı</option>
                </select>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btnx flex-fill" type="submit" data-i18n="btnPublish">Talebi Yayınla</button>
              <button class="btnx alt" type="button" id="genInvite">Davet Linki</button>
            </div>
            <div class="smallmut mt-2" id="inviteOut"></div>
          </form>
          <div class="mt-3">
            <div class="badge-chip">Brief Skoru: <b id="briefScore">0</b>/100</div>
            <div class="smallmut" id="briefTips"></div>
          </div>
          <div class="pilot-box mt-3">
            <i class="fas fa-check-circle"></i>
            <div>
              <h6 class="mb-1">Pilot — Ücretsiz</h6>
              <p class="mb-0 section-note">Bu aşamada ücret alınmaz. Birlikte test ediyoruz.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="cardx">
          <h4 class="mb-2" data-i18n="inbox">📬 Mesajlar (Teklifler)</h4>
          <div id="clinicMessages"></div>
        </div>

        <div class="cardx">
          <h4 class="mb-2" data-i18n="myReqs">📋 Benim Taleplerim</h4>
          <div class="table-wrap table-responsive">
            <table class="table table-sm align-middle" id="myClinicReqs">
              <thead><tr><th>ID</th><th>Ürün</th><th>Kat.</th><th>Miktar</th><th>Termin</th><th>Durum</th><th>IoT</th><th>Sil</th><th>Yayın</th></tr></thead>
              <tbody><tr><td colspan="9" class="text-muted">Kayıt yok.</td></tr></tbody>
            </table>
          </div>
          <div id="myClinicReqsCards" class="card-list"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- SUPPLIER -->
<section id="supplier" class="page">
  <div class="container w-1100">
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="cardx">
          <h3 class="mb-2"><i class="fa-solid fa-truck"></i> <span data-i18n="supplierProfile">Tedarikçi Profili</span></h3>
          <p class="section-note" data-i18n="profileKey2">E-posta profil anahtarındır. Teklifler bu e-posta ile ilişkilendirilir.</p>
          <form id="supplierProfileForm">
            <div class="mb-2"><label class="form-label" data-i18n="labFirm">Firma</label><input class="form-control" name="company" required></div>
            <div class="row">
              <div class="col-md-6 mb-2"><label class="form-label" data-i18n="labAuth">Yetkili</label><input class="form-control" name="name" required></div>
              <div class="col-md-6 mb-2"><label class="form-label" data-i18n="labPhone">Telefon</label><input class="form-control" name="phone" required></div>
            </div>
            <!-- New supplier fields: tax number, mersis, CE/ISO docs, ÜTS link -->
            <div class="mb-2"><label class="form-label" data-i18n="labTax">Vergi No</label><input class="form-control" name="tax"></div>
            <div class="mb-2"><label class="form-label" data-i18n="labMersis">MERSİS No</label><input class="form-control" name="mersis"></div>
            <div class="mb-2"><label class="form-label" data-i18n="labDocs">CE/ISO Belgeleri</label><input class="form-control" type="file" accept=".pdf,image/*" name="docs" multiple></div>
            <div class="mb-2"><label class="form-label" data-i18n="labUts">ÜTS/TİTUBB Link</label><input class="form-control" type="url" name="uts"></div>
            <!-- Premium abonelik alanı -->
            <div class="mb-2"><label class="form-label" data-i18n="labPremium">Premium Abonelik</label>
              <select class="form-select" name="premium">
                <option value="no">Hayır</option>
                <option value="yes">Evet</option>
              </select>
            </div>
            <div class="mb-3"><label class="form-label" data-i18n="labEmail">E-posta (profil anahtarı)</label><input class="form-control" type="email" name="email" required></div>
            <button class="btnx w-100" type="submit" data-i18n="btnSaveLoad">Profili Kaydet / Yükle</button>
          </form>
          <div id="supplierProfileInfo" class="mt-3 section-note"></div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="cardx">
          <h4 class="mb-2" data-i18n="openPick">🔎 Açık Taleplerden Seç &amp; Teklif Ver</h4>
          <div class="row g-2 align-items-end">
            <div class="col-md-5"><label class="form-label" data-i18n="labSearch">Ara</label><input class="form-control" id="searchReq" placeholder="ürün/klinik"></div>
            <div class="col-md-4"><label class="form-label" data-i18n="labCat">Kategori</label>
              <select id="filterCat" class="form-select"><option value="">Hepsi</option><option>Medikal Cihaz</option><option>Sarf Malzeme</option><option>Ameliyat Malzemesi</option><option>Laboratuvar</option><option>Radyoloji</option><option>Diş Sağlığı</option><option>Hizmet</option><option>Diğer</option></select>
            </div>
            <div class="col-md-3"><label class="form-label" data-i18n="labStatus">Durum</label>
              <select id="filterStatus" class="form-select"><option value="">Hepsi</option><option value="open">Açık</option><option value="selected">Seçildi</option><option value="closed">Kapalı</option></select>
            </div>
          </div>
          <div class="table-wrap table-responsive mt-2">
            <table class="table table-sm align-middle" id="reqTableSup">
              <thead><tr><th>ID</th><th>Klinik</th><th>Ürün</th><th>Kat.</th><th>Miktar</th><th>Termin</th><th>Durum</th><th>IoT</th><th></th></tr></thead>
              <tbody><tr><td colspan="9" class="text-muted">Kayıt yok.</td></tr></tbody>
            </table>
          </div>
          <div id="reqTableSupCards" class="card-list"></div>
          <hr class="my-3">
          <h5 class="mb-2" data-i18n="bidForm">✍️ Teklif Formu</h5>
          <form id="supplierBidForm">
            <div class="row">
              <div class="col-md-5 mb-2"><label class="form-label">Talep ID</label><input class="form-control" id="bidTalepId" name="talep_id" required placeholder="TLP-YYYYMMDD-XXXX"></div>
              <div class="col-md-4 mb-2"><label class="form-label" data-i18n="unitPrice">Birim Fiyat</label><input class="form-control" type="number" step="0.01" name="fiyat" required></div>
              <div class="col-md-3 mb-2"><label class="form-label" data-i18n="currency">Para</label><select class="form-select" name="para"><option>TRY</option><option>USD</option><option>EUR</option></select></div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-2"><label class="form-label" data-i18n="deliveryDays">Teslim (gün)</label><input class="form-control" type="number" min="1" name="termin_gun" required></div>
              <div class="col-md-4 mb-2"><label class="form-label">Geçerlilik (gün)</label><input class="form-control" type="number" min="1" name="valid_days" value="7"></div>
              <div class="col-md-4 mb-2"><label class="form-label">Katalog/Belge (PDF)</label><input class="form-control" type="file" accept=".pdf,image/*" name="file"></div>
            </div>
            <!-- Ek alanlar: stok, sponsor, garanti, bakım -->
            <div class="row">
              <div class="col-md-4 mb-2">
                <label class="form-label" data-i18n="labStock">Stok</label>
                <input class="form-control" type="number" min="0" name="stock">
              </div>
              <div class="col-md-4 mb-2">
                <label class="form-label" data-i18n="labSponsor">Sponsorlu Teklif</label>
                <select class="form-select" name="sponsor">
                  <option value="no">Hayır</option>
                  <option value="yes">Evet</option>
                </select>
              </div>
              <div class="col-md-4 mb-2">
                <label class="form-label" data-i18n="labWarranty">Garanti (yıl)</label>
                <input class="form-control" type="number" min="0" step="0.1" name="warranty">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label" data-i18n="labMaintenance">Bakım periyodu (ay)</label>
                <input class="form-control" type="number" min="0" name="maintenance">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label" data-i18n="notes">Teklif Notları</label>
                <input class="form-control" name="not" placeholder="sertifika, garanti, teslim koşulu…">
              </div>
            </div>
            <!-- Sonu ek alanlar -->
            <button class="btnx w-100" type="submit" data-i18n="btnSendBid">Teklifi Gönder</button>
          </form>
          <div class="section-note mt-2" data-i18n="bidNote">Teklif, ilgili kliniğin <b>Mesajlar</b> bölümüne düşer ve admin e-postasına bildirim gider.</div>
        </div>
        <!-- Yeni: tedarikçinin kendi teklifleri listesi -->
        <div class="cardx mt-4" id="supplierBidsSection" style="display:none">
          <h5 class="mb-2" data-i18n="myBids">📑 Benim Tekliflerim</h5>
          <div class="table-wrap table-responsive">
            <table class="table table-sm align-middle" id="myBidTable">
              <thead><tr><th>Talep ID</th><th>Fiyat</th><th>Stok</th><th>Sponsor</th><th>Durum</th><th>Aşama</th><th></th></tr></thead>
              <tbody><tr><td colspan="7" class="text-muted">Kayıt yok.</td></tr></tbody>
            </table>
          </div>
          <div id="myBidCards" class="card-list"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- REQUESTS (public) -->
<section id="requests" class="page">
  <div class="container w-1100">
    <h3 class="mb-2"><i class="fa-solid fa-list"></i> <span data-i18n="openReqs">Açık Talepler</span></h3>

    <div class="cardx">
      <div class="row g-2 align-items-end">
        <div class="col-md-5"><label class="form-label" data-i18n="labSearch">Ara</label><input class="form-control" id="searchReqPub" placeholder="ürün/klinik"></div>
        <div class="col-md-3"><label class="form-label" data-i18n="labCat">Kategori</label>
          <select id="filterCatPub" class="form-select"><option value="">Hepsi</option><option>Medikal Cihaz</option><option>Sarf Malzeme</option><option>Ameliyat Malzemesi</option><option>Laboratuvar</option><option>Radyoloji</option><option>Diş Sağlığı</option><option>Hizmet</option><option>Diğer</option></select>
        </div>
        <div class="col-md-2"><label class="form-label" data-i18n="labStatus">Durum</label>
          <select id="filterStatusPub" class="form-select"><option value="">Hepsi</option><option value="open">Açık</option><option value="selected">Seçildi</option><option value="closed">Kapalı</option></select>
        </div>
        <div class="col-md-2"><label class="form-label">Sırala</label>
          <select id="sortReq" class="form-select"><option value="new">En Yeni</option><option value="qty">Miktar</option><option value="date">Termin</option></select>
        </div>
      </div>
    </div>

    <div class="cardx">
      <div class="table-wrap table-responsive">
        <table class="table table-sm align-middle" id="reqTablePub">
          <thead><tr><th>ID</th><th>Klinik</th><th>Ürün</th><th>Kat.</th><th>Miktar</th><th>Termin</th><th>Durum</th><th>IoT</th></tr></thead>
          <tbody><tr><td colspan="8" class="text-muted">Kayıt yok.</td></tr></tbody>
        </table>
      </div>
      <div id="reqTablePubCards" class="card-list"></div>
      <div class="section-note" data-i18n="pubNote">Bu sayfa herkese açıktır. Özel (davet) talepler burada görünmez.</div>
    </div>
  </div>
</section>

<!-- DEMO -->
<section id="demo" class="page">
  <div class="container w-1100">
    <h3 class="mb-2"><i class="fa-solid fa-flask"></i> <span data-i18n="demoTitle">Demo Merkezi</span></h3>
    <p class="section-note" data-i18n="demoIntro">Bu sayfa sadece DEMO amaçlıdır. Veriler örnektir.</p>
    <!-- Demo stats -->
    <div class="demo-stats">
      <div class="demo-stat"><h6 data-i18n="demoTotalLabel">Toplam Demo RFQ</h6><div class="big" id="demoTotal">0</div></div>
      <div class="demo-stat"><h6 data-i18n="demoAvgOffersLabel">Ortalama Teklif Sayısı</h6><div class="big" id="demoAvgOffers">—</div></div>
      <div class="demo-stat"><h6 data-i18n="demoAvgSavingsLabel">Ortalama Tasarruf</h6><div class="big" id="demoAvgSavings">—</div></div>
    </div>
    <!-- Demo request list -->
    <div class="cardx">
      <h5 class="mb-2"><i class="fa-solid fa-list"></i> <span data-i18n="demoReqs">Demo Talepler</span></h5>
      <div id="demoReqs"></div>
    </div>
  </div>
</section>

<!-- TRUST -->
<section id="trust" class="page">
  <div class="container w-1100">
    <h3 class="mb-2"><i class="fa-solid fa-shield-halved"></i> <span data-i18n="trustTitle">Güven &amp; Uyum</span></h3>
    <div class="cardx">
      <p class="section-note" data-i18n="trustContent">Platformumuz CE, ISO 13485, ÜTS/TİTUBB ve KVKK uyumludur. Belgeler tedarikçi beyanına dayanır.</p>
      <ul>
        <li data-i18n="trustItem1">CE sertifikası gereklidir ve doğrulanır.</li>
        <li data-i18n="trustItem2">ISO 13485 kalite yönetim sistemi, tıbbi cihazlar için temel standarttır.</li>
        <li data-i18n="trustItem3">ÜTS/TİTUBB kayıt numaraları tedarikçiler tarafından sağlanır.</li>
        <li data-i18n="trustItem4">KVKK kapsamında kişisel veriler korunur ve üçüncü kişilerle paylaşılmaz.</li>
      </ul>
      <p class="section-note" data-i18n="trustFooter">Meditek sadece aracı bir platformdur; ürün kalitesi ve teslimattan tedarikçi sorumludur.</p>
    </div>
  </div>
</section>

<!-- ADMIN -->
<section id="admin" class="page">
  <div class="container w-1100">
    <div class="cardx text-center">
      <h3 class="mb-2"><i class="fa-solid fa-cogs"></i> Admin</h3>
      <p class="section-note">Kayıtlar localStorage'da tutulur, e-posta <b>kadirmanay58@gmail.com</b> adresine gider.</p>
      <div class="d-flex flex-wrap gap-2 justify-content-center">
        <button class="btnx" id="exportCSV"><i class="fa-solid fa-file-export"></i> CSV Dışa Aktar</button>
        <button class="btnx" id="exportJSON"><i class="fa-solid fa-file-code"></i> JSON Dışa Aktar</button>
        <label class="btnx alt mb-0" for="importJSON"><i class="fa-solid fa-file-import"></i> JSON İçe Aktar</label>
        <input id="importJSON" type="file" accept="application/json" hidden>
        <button class="btnx alt" id="clearAll"><i class="fa-solid fa-broom"></i> Verileri Temizle</button>
      </div>
    </div>

    <div class="cardx">
      <h5>Klinik Talepleri</h5>
      <div class="table-wrap table-responsive">
        <table class="table table-sm" id="tblClinicAdmin">
          <thead><tr><th>ID</th><th>Klinik</th><th>Grup</th><th>Ürün</th><th>Kat.</th><th>Miktar</th><th>Termin</th><th>Durum</th><th>IoT</th><th>Yetkili</th><th>E-posta</th><th>Tarih</th></tr></thead>
          <tbody><tr><td colspan="12" class="text-muted">Kayıt yok.</td></tr></tbody>
        </table>
      </div>
      <div id="tblClinicAdminCards" class="card-list"></div>

      <h5 class="mt-4">Tedarikçi Teklifleri</h5>
      <div class="table-wrap table-responsive">
        <table class="table table-sm" id="tblSuppAdmin">
          <thead><tr><th>Talep ID</th><th>Firma</th><th>Fiyat</th><th>Para</th><th>Termin(gün)</th><th>Geçerli (gün)</th><th>Stok</th><th>Sponsor</th><th>Garanti(yıl)</th><th>Bakım(ay)</th><th>Durum</th><th>Yetkili</th><th>E-posta</th><th>Tarih</th></tr></thead>
          <tbody><tr><td colspan="14" class="text-muted">Kayıt yok.</td></tr></tbody>
        </table>
      </div>
      <div id="tblSuppAdminCards" class="card-list"></div>
    </div>
  </div>
</section>

<!-- TOAST -->
<div id="toasts" class="toast-wrap"></div>

<!-- LOTTIE Success modal (inline, simple) -->
<div id="lottieOK" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;background:rgba(0,0,0,.35)">
  <div class="cardx text-center">
    <tgs-player autoplay loop src="https://lottie.host/9d8b3f8a-0d12-4b67-9aa2-2c5f4a9d2c6e/x.json" style="width:140px;height:140px"></tgs-player>
    <div class="mt-2">İşlem başarılı!</div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= I18N ========= */
const I18N = {
  tr:{
    navClinic:"Klinik", navSupplier:"Tedarikçi", navRequests:"Açık Talepler", navDemo:"Demo", navAdmin:"Admin", navTrust:"Güven & Uyum",
    heroTitle:"Şeffaf Teklif. Hızlı Karar.",
    heroSub:"Klinik talep açar → Tedarikçi listeden görüp <b>Teklif Ver</b>ir → Teklif kliniğin <b>Mesajlar</b> bölümüne düşer. Pilot: localStorage + e-posta.",
    heroRole1:"🏥 Klinik için devam et", heroRole2:"🚚 Tedarikçi için devam et",
    ctaClinic:"🏥 Klinik Profili", ctaSupplier:"🚚 Tedarikçi Profili", ctaRequests:"📋 Açık Talepler", ctaAdmin:"⚙️ Admin", ctaDemo:"🧪 Demo",
    pilotTitle:"Pilot Uygulama — Ücretsiz", pilotText:"Meditek şu an <b>pilot</b> aşamada. Klinikler ve tedarikçiler için sistem <b>ücretsiz</b>. Geri bildirimler deneyimi iyileştirir.",
    miniDash:"Hızlı İstatistik", statTotal:"Toplam Talep", statAvg:"Ortalama Teklif Süresi", statAccepted:"Kabul Edilen Teklif", statFav:"Favori Tedarikçiler",
    trendTitle:"Fiyat Trendi (Son 10 Teklif)", trendNote:"Not: Aynı kategori için son 10 teklifin ortalama birim fiyatı.",
    forecastTitle:"Tahmini Fiyat Analizi", forecastNote:"Son tekliflere dayanarak basit bir doğrusal regresyonla tahmini trend.",
    analyticsTitle:"Pazar Analitiği", analyticsNote:"Kategorilere göre ortalama fiyat ve talep dağılımı",
    clinicProfile:"Klinik Profili", profileKey:"E-posta profil anahtarındır. Aynı e-posta ile giriş yaparsan kayıtların yüklenir.",
    labGroup:"Grup", labIot:"IoT Entegrasyonu", labOrg:"Klinik/Hastane", labAuth:"Yetkili", labPhone:"Telefon", labEmail:"E-posta (profil anahtarı)", labCat:"Kategori", labTermin:"Beklenen Termin",
    labDesc:"Ürün Açıklaması", labQty:"Miktar", labUnit:"Birim", btnSaveLoad:"Profili Kaydet / Yükle", btnPublish:"Talebi Yayınla",
    inbox:"📬 Mesajlar (Teklifler)", myReqs:"📋 Benim Taleplerim", myBids:"📑 Benim Tekliflerim",
    supplierProfile:"Tedarikçi Profili", profileKey2:"E-posta profil anahtarındır. Teklifler bu e-posta ile ilişkilendirilir.",
    labFirm:"Firma", openPick:"🔎 Açık Taleplerden Seç & Teklif Ver", labSearch:"Ara", labStatus:"Durum", bidForm:"✍️ Teklif Formu",
    unitPrice:"Birim Fiyat", currency:"Para", deliveryDays:"Teslim (gün)", notes:"Teklif Notları", btnSendBid:"Teklifi Gönder", bidNote:"Teklif, kliniğin Mesajlar bölümüne düşer ve admin e-postasına bildirim gider.",
    openReqs:"Açık Talepler", pubNote:"Bu sayfa herkese açıktır. Özel (davet) talepler burada görünmez.",
    labStock:"Stok", labSponsor:"Sponsorlu Teklif", labWarranty:"Garanti (yıl)", labMaintenance:"Bakım periyodu (ay)", labPremium:"Premium Abonelik", labTax:"Vergi No", labMersis:"MERSİS No", labDocs:"CE/ISO Belgeleri", labUts:"ÜTS/TİTUBB Link",
    catSarf:"Sarf Malzeme", catCihaz:"Medikal Cihaz", catLab:"Laboratuvar", catRad:"Radyoloji", catDis:"Diş Sağlığı", catHizmet:"Hizmet",
    homeGuideTitle:"Klinikler için kategorilere göre şablonlar", homeGuideDesc:"Taleplerinizi hızla oluşturmak için kategori seçin ve hazır şablonları kullanın.",
    firstGuide:"İlk Talebimi Nasıl Açarım?", firstGuideDesc:"Kategori seçin, hazır şablonu doldurun ve Talebi Yayınla butonuna tıklayın. Aşağıdaki kısa video size yol gösterecek.", demoLink:"Demo RFQ oluştur",
    trustBand:"CE • ISO 13485 • ÜTS/TİTUBB • KVKK — Meditek aracı platformdur, ticari sorumluluk taraflardadır.",
    supportMsg:"5 dk içinde dönüş: WhatsApp Business +90 XXX XXX XX XX",
    demoTitle:"Demo Merkezi", demoIntro:"Bu sayfa sadece DEMO amaçlıdır. Veriler örnektir.", demoReqs:"Demo Talepler", demoTotalLabel:"Toplam Demo RFQ", demoAvgOffersLabel:"Ortalama Teklif Sayısı", demoAvgSavingsLabel:"Ortalama Tasarruf",
    trustTitle:"Güven & Uyum", trustContent:"Platformumuz CE, ISO 13485, ÜTS/TİTUBB ve KVKK uyumludur. Belgeler tedarikçi beyanına dayanır.", trustItem1:"CE sertifikası gereklidir ve doğrulanır.", trustItem2:"ISO 13485 kalite yönetim sistemi, tıbbi cihazlar için temel standarttır.", trustItem3:"ÜTS/TİTUBB kayıt numaraları tedarikçiler tarafından sağlanır.", trustItem4:"KVKK kapsamında kişisel veriler korunur ve üçüncü kişilerle paylaşılmaz.", trustFooter:"Meditek sadece aracı bir platformdur; ürün kalitesi ve teslimattan tedarikçi sorumludur.",
    rozetPending:"Belge Bekliyor", rozetPartial:"Ön Onaylı", rozetFull:"Onaylı"
  },
  en:{
    navClinic:"Clinic", navSupplier:"Supplier", navRequests:"Open Requests", navDemo:"Demo", navAdmin:"Admin", navTrust:"Trust & Compliance",
    heroTitle:"Transparent Quotes. Faster Decisions.",
    heroSub:"Clinics publish a request → Suppliers bid → Quotes appear in the clinic’s <b>Messages</b>. Pilot: localStorage + email.",
    heroRole1:"🏥 Continue as Clinic", heroRole2:"🚚 Continue as Supplier",
    ctaClinic:"🏥 Clinic Profile", ctaSupplier:"🚚 Supplier Profile", ctaRequests:"📋 Open Requests", ctaAdmin:"⚙️ Admin", ctaDemo:"🧪 Demo",
    pilotTitle:"Pilot — Free", pilotText:"Meditek is in <b>pilot</b>. It’s <b>free</b> for clinics & suppliers. Your feedback helps us improve.",
    miniDash:"Quick Stats", statTotal:"Total Requests", statAvg:"Avg Time to First Bid", statAccepted:"Accepted Offers", statFav:"Favorite Suppliers",
    trendTitle:"Price Trend (Last 10 Bids)", trendNote:"Avg unit price for last 10 bids in same category.",
    forecastTitle:"Predictive Price Analysis", forecastNote:"Simple linear regression forecast based on recent bids.",
    analyticsTitle:"Market Analytics", analyticsNote:"Average price & demand distribution by category",
    clinicProfile:"Clinic Profile", profileKey:"Email is your profile key.",
    labGroup:"Group", labIot:"IoT Integration", labOrg:"Clinic/Hospital", labAuth:"Contact", labPhone:"Phone", labEmail:"Email (profile key)", labCat:"Category", labTermin:"Expected Delivery Date",
    labDesc:"Product Description", labQty:"Quantity", labUnit:"Unit", btnSaveLoad:"Save / Load Profile", btnPublish:"Publish Request",
    inbox:"📬 Messages (Offers)", myReqs:"📋 My Requests", myBids:"📑 My Bids",
    supplierProfile:"Supplier Profile", profileKey2:"Email acts as your profile key.",
    labFirm:"Company", openPick:"🔎 Pick from Open Requests & Bid", labSearch:"Search", labStatus:"Status", bidForm:"✍️ Bid Form",
    unitPrice:"Unit Price", currency:"Currency", deliveryDays:"Lead time (days)", notes:"Bid Notes", btnSendBid:"Send Bid", bidNote:"Bid arrives in clinic’s Messages and triggers admin email.",
    openReqs:"Open Requests", pubNote:"Public page. Private (invited) requests are hidden.",
    labStock:"Stock", labSponsor:"Sponsored Offer", labWarranty:"Warranty (years)", labMaintenance:"Maintenance interval (months)", labPremium:"Premium Subscription", labTax:"Tax No", labMersis:"MERSIS No", labDocs:"CE/ISO Documents", labUts:"ÜTS/TİTUBB Link",
    catSarf:"Consumables", catCihaz:"Medical Device", catLab:"Laboratory", catRad:"Radiology", catDis:"Dental", catHizmet:"Service",
    homeGuideTitle:"Templates by Category", homeGuideDesc:"Select a category to use pre-filled request templates.",
    firstGuide:"How do I create my first RFQ?", firstGuideDesc:"Select a category, fill the template and click Publish Request. The short video below will guide you.", demoLink:"Create Demo RFQ",
    trustBand:"CE • ISO 13485 • ÜTS/TİTUBB • KVKK — Meditek is an intermediary platform; commercial responsibility lies with the parties.",
    supportMsg:"Response within 5 min: WhatsApp Business +90 XXX XXX XX XX",
    demoTitle:"Demo Center", demoIntro:"This page is for DEMO purposes only. Data is fictitious.", demoReqs:"Demo Requests", demoTotalLabel:"Total Demo RFQs", demoAvgOffersLabel:"Avg bids per RFQ", demoAvgSavingsLabel:"Avg savings",
    trustTitle:"Trust & Compliance", trustContent:"Our platform complies with CE, ISO 13485, ÜTS/TİTUBB, and KVKK regulations. Documents are self-attested by suppliers.", trustItem1:"CE certification is mandatory and verified.", trustItem2:"ISO 13485 quality system is fundamental for medical devices.", trustItem3:"ÜTS/TİTUBB registration numbers are provided by suppliers.", trustItem4:"Personal data is protected under KVKK and not shared with third parties.", trustFooter:"Meditek is only an intermediary platform; suppliers are responsible for product quality and delivery.",
    rozetPending:"Pending Docs", rozetPartial:"Pre‑Approved", rozetFull:"Approved"
  }
};
let CUR_LANG = localStorage.getItem("meditek_lang") || "tr";
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n");
    el.innerHTML = (I18N[CUR_LANG][k]||el.innerHTML);
  });
  document.getElementById("langTR").classList.toggle("active", CUR_LANG==="tr");
  document.getElementById("langEN").classList.toggle("active", CUR_LANG==="en");
}
function setLang(l){ CUR_LANG=l; localStorage.setItem("meditek_lang",l); applyI18n(); }

/* ========= AYARLAR ========= */
const EMAIL_TO = "kadirmanay58@gmail.com";
const EMAIL_ENDPOINT = "https://formsubmit.co/ajax/" + encodeURIComponent(EMAIL_TO);

/* ========= STORAGE & SCHEMA ========= */
const SCHEMA_VER = 3;
const LS = {
  ver:"meditek_schema_ver",
  clinicReqs: "meditek_clinic_reqs",
  supplierBids: "meditek_supplier_bids",
  messages: "meditek_messages_map",
  clinicProfiles: "meditek_profiles_clinic",
  supplierProfiles: "meditek_profiles_supplier",
  currentClinic: "meditek_current_clinic_email",
  currentSupplier: "meditek_current_supplier_email",
  favSuppliers: "meditek_fav_suppliers",
  favClinics: "meditek_fav_clinics",
  supplyTracking: "meditek_supply_tracking",
  contracts: "meditek_contracts",
  selectedCategory: "meditek_selected_category",
  role: "meditek_role"
};
function migrate(){
  const v=parseInt(localStorage.getItem(LS.ver)||"1",10);
  if(v<2){
    let CR=JSON.parse(localStorage.getItem(LS.clinicReqs)||"[]");
    CR=CR.map(r=>({ status: "open", vis:"public", token:r.token||null, ...r }));
    localStorage.setItem(LS.clinicReqs, JSON.stringify(CR));
    localStorage.setItem(LS.ver, String(2));
  }
  if(v<3){
    if(!localStorage.getItem(LS.supplyTracking)) localStorage.setItem(LS.supplyTracking, "{}");
    if(!localStorage.getItem(LS.contracts)) localStorage.setItem(LS.contracts, "{}");
    localStorage.setItem(LS.ver, String(3));
  }
}
migrate();

let clinicReqs = JSON.parse(localStorage.getItem(LS.clinicReqs)||"[]");
let supplierBids = JSON.parse(localStorage.getItem(LS.supplierBids)||"[]");
let messagesMap = JSON.parse(localStorage.getItem(LS.messages)||"{}");
let clinicProfiles = JSON.parse(localStorage.getItem(LS.clinicProfiles)||"{}");
let supplierProfiles = JSON.parse(localStorage.getItem(LS.supplierProfiles)||"{}");
let favSuppliers = JSON.parse(localStorage.getItem(LS.favSuppliers)||"[]");
let favClinics = JSON.parse(localStorage.getItem(LS.favClinics)||"[]");
let supplyTracking = JSON.parse(localStorage.getItem(LS.supplyTracking)||"{}");
let contracts = JSON.parse(localStorage.getItem(LS.contracts)||"{}");
let selectedCategory = localStorage.getItem(LS.selectedCategory) || "";

function saveAll(){
  localStorage.setItem(LS.clinicReqs, JSON.stringify(clinicReqs));
  localStorage.setItem(LS.supplierBids, JSON.stringify(supplierBids));
  localStorage.setItem(LS.messages, JSON.stringify(messagesMap));
  localStorage.setItem(LS.clinicProfiles, JSON.stringify(clinicProfiles));
  localStorage.setItem(LS.supplierProfiles, JSON.stringify(supplierProfiles));
  localStorage.setItem(LS.favSuppliers, JSON.stringify(favSuppliers));
  localStorage.setItem(LS.favClinics, JSON.stringify(favClinics));
  localStorage.setItem(LS.supplyTracking, JSON.stringify(supplyTracking));
  localStorage.setItem(LS.contracts, JSON.stringify(contracts));
  if(selectedCategory) localStorage.setItem(LS.selectedCategory, selectedCategory);
}

function tid(){
  const d=new Date(),p=n=>String(n).padStart(2,"0");
  return `TLP-${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${Math.floor(Math.random()*9000+1000)}`;
}
function toast(msg,type="info"){
  const box=document.createElement("div");
  box.className=`toastx ${type}`;
  box.innerHTML=`<i class="fa-solid ${type==="success"?"fa-check-circle":type==="error"?"fa-triangle-exclamation":"fa-circle-info"}"></i><div>${msg}</div>`;
  document.getElementById("toasts").appendChild(box);
  setTimeout(()=>box.remove(),5000);
}
async function sendEmail(subject, payload){
  try{
    const res = await fetch(EMAIL_ENDPOINT,{
      method:"POST", headers:{ "Content-Type":"application/json","Accept":"application/json" },
      body: JSON.stringify({ _subject:subject, ...payload })
    });
    return res.ok;
  }catch{ return false }
}
function fmtDateTime(x){ return new Date(x).toLocaleString(); }
function currentClinicEmail(){ return localStorage.getItem(LS.currentClinic)||""; }
function currentSupplierEmail(){ return localStorage.getItem(LS.currentSupplier)||""; }
function currentRole(){ return localStorage.getItem(LS.role)||""; }

/* ========= Helpers ========= */
function categoryIcon(cat){
  const map={
    "Medikal Cihaz":"fa-stethoscope",
    "Tüketim Malzemesi":"fa-boxes-stacked",
    "Sarf Malzeme":"fa-boxes-stacked",
    "Ameliyat Malzemesi":"fa-scissors",
    "Laboratuvar":"fa-vials",
    "Radyoloji":"fa-x-ray",
    "Diş Sağlığı":"fa-tooth",
    "Hizmet":"fa-handshake",
    "Diğer":"fa-cubes"
  };
  return map[cat]||"fa-cubes";
}
function showOK(){
  const m=document.getElementById("lottieOK"); m.style.display="flex"; setTimeout(()=>m.style.display="none",1200);
}

/* ========= Supply Chain Helpers ========= */
const SUPPLY_STAGES = ["Ordered","Processing","Dispatched","Delivered"];
function initTracking(talepId){
  supplyTracking[talepId] = { stageIndex: 0, timeline: [{stage: SUPPLY_STAGES[0], at: new Date().toISOString()}] };
  saveAll();
}
function progressSupplyChain(talepId){
  const tr=supplyTracking[talepId];
  if(!tr) return;
  // Only the supplier of the accepted bid or admin can update
  const accepted = supplierBids.find(b=>b.talep_id===talepId && b.status==='selected');
  const allowedSupplier = accepted? accepted.email : null;
  const pageHash = location.hash || "";
  if(allowedSupplier && currentSupplierEmail() !== allowedSupplier && !pageHash.includes("#admin")){
    toast(CUR_LANG==='tr'?"Sadece ilgili tedarikçi güncelleyebilir.":"Only the relevant supplier can update.","error");
    return;
  }
  if(tr.stageIndex < SUPPLY_STAGES.length-1){
    tr.stageIndex++;
    tr.timeline.push({stage: SUPPLY_STAGES[tr.stageIndex], at: new Date().toISOString()});
    saveAll();
    renderClinicDash();
    renderSupplierDash();
  } else {
    toast(CUR_LANG==='tr'?"Tedarik zinciri tamamlandı.":"Supply chain completed.","success");
  }
}
function getSupplyTimeline(talepId){
  return supplyTracking[talepId]?.timeline||[];
}
function getSupplyCurrentStage(talepId){
  return SUPPLY_STAGES[supplyTracking[talepId]?.stageIndex||0];
}

/* ========= Contract generation ========= */
function generateContract(bid){
  const req = clinicReqs.find(r=>r.id===bid.talep_id) || {};
  const contract = {
    contractId: `CNT-${Date.now()}-${Math.floor(Math.random()*1000)}`,
    talepId: bid.talep_id,
    klinik: req.klinik,
    tedarikci: bid.firma,
    miktar: req.miktar,
    birim: req.birim,
    fiyat: bid.fiyat,
    para: bid.para,
    teslimSuresi: bid.termin_gun,
    garantiYil: bid.warranty||0,
    bakımAy: bid.maintenance||0,
    imzalanmaTarihi: new Date().toISOString(),
    icerik: `Talep ${bid.talep_id} için ${req.miktar} ${req.birim} ${req.urun} ${bid.firma} tarafından ${bid.fiyat} ${bid.para} birim fiyatla ve ${bid.termin_gun} gün teslim süresiyle karşılanacaktır. Garanti süresi ${bid.warranty||0} yıl, bakım periyodu ${bid.maintenance||0} aydır.`
  };
  contracts[contract.contractId] = contract;
  saveAll();
  const blob = new Blob([JSON.stringify(contract,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  return {contract, url};
}

/* ========= Router ========= */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  (document.getElementById(id)||document.getElementById("home")).classList.add("active");
  document.querySelectorAll(".nav-link").forEach(a=>{
    a.classList.toggle("active", a.getAttribute("href")==="#"+id);
  });
  if(id==="home") renderHome();
  if(id==="clinic") renderClinicDash();
  if(id==="supplier") renderSupplierDash();
  if(id==="requests") renderRequestsPublic();
  if(id==="admin") renderAdmin();
  if(id==="demo") renderDemo();
  if(id==="trust") renderTrust();
}
window.addEventListener("hashchange",()=>showPage(location.hash.substring(1)||"home"));

/* ========= Brief Skoru ========= */
function computeBriefScore(txt, qty, unit, termin){
  let score=0; const tips=[];
  const t=(txt||"").toLowerCase();
  if(qty>0){score+=15}else tips.push(CUR_LANG==='tr'?"Miktar belirtin.":"Specify quantity.");
  if(unit){score+=5}else tips.push(CUR_LANG==='tr'?"Birim seçin.":"Select a unit.");
  if(termin){score+=10}else tips.push(CUR_LANG==='tr'?"Termin tarihi ekleyin.":"Add delivery date.");
  if(/\bce\b/.test(t)) score+=15; else tips.push(CUR_LANG==='tr'?"CE gerekliliğini belirtin.":"Indicate CE requirement.");
  if(/\bgaranti|\byıl\b/.test(t)) score+=10; else tips.push(CUR_LANG==='tr'?"Garanti süresi ekleyin.":"Add warranty duration.");
  if(/\bmodel|\bmarka/.test(t)) score+=10; else tips.push(CUR_LANG==='tr'?"Marka/model örneği verin.":"Provide brand/model example.");
  if(/\blead|\bteslim|\btedarik/.test(t)) score+=10; else tips.push(CUR_LANG==='tr'?"Teslim/tedarik koşulu yazın.":"State delivery/lead conditions.");
  if(/\bsertifika|\biso|\biec|\bfda/.test(t)) score+=15; else tips.push(CUR_LANG==='tr'?"Sertifikalar (ISO/IEC/FDA) ekleyin.":"Add certificates (ISO/IEC/FDA).");
  if(t.length>40) score+=10; else tips.push(CUR_LANG==='tr'?"Biraz daha ayrıntı ekleyin.":"Provide more details.");
  return {score:Math.min(score,100), tips};
}

/* ========= INIT ========= */
document.addEventListener("DOMContentLoaded",()=>{
  applyI18n();
  document.getElementById("langTR").onclick=()=>setLang("tr");
  document.getElementById("langEN").onclick=()=>setLang("en");
  document.getElementById("darkToggle").onclick=()=>{
    const r=document.documentElement;
    const isDark=r.getAttribute("data-theme")==="dark";
    r.setAttribute("data-theme", isDark?"light":"dark");
    localStorage.setItem("meditek_theme", isDark?"light":"dark");
  };
  const tm=localStorage.getItem("meditek_theme"); if(tm) document.documentElement.setAttribute("data-theme", tm);
  document.querySelectorAll(".nav-link").forEach(a=>a.addEventListener("click",e=>{
    e.preventDefault(); const id=a.getAttribute("href").replace("#",""); history.pushState(null,"","#"+id); showPage(id);
  }));
  // role buttons
  document.getElementById("btnClinicRole").onclick=()=>{ localStorage.setItem(LS.role,"clinic"); toast(I18N[CUR_LANG].roleSaved||"Rol kaydedildi!", "success"); showPage("clinic"); };
  document.getElementById("btnSupplierRole").onclick=()=>{ localStorage.setItem(LS.role,"supplier"); toast(I18N[CUR_LANG].roleSaved||"Rol kaydedildi!", "success"); showPage("supplier"); };
  // forms
  bindClinic();
  bindSupplier();
  bindAdmin();
  bindSearchFilters();
  // initial page
  showPage(location.hash.substring(1)||"home");
});

/* ========= Category selection ========= */
function handleCategoryClick(cat){
  selectedCategory = cat;
  localStorage.setItem(LS.selectedCategory, cat);
  // If the user is clinic role, navigate to clinic and prefill category
  const role = currentRole();
  if(role==="clinic"){ showPage("clinic"); }
  else if(role==="supplier"){ showPage("supplier"); }
  else {
    // no role selected, just notify
    toast(CUR_LANG==='tr'?"Rol seçilmedi. Önce bir rol seçin.":"Role not selected. Please select a role first.","info");
  }
}

/* ========= CLINIC ========= */
function bindClinic(){
  const f1=document.getElementById("clinicProfileForm");
  const f2=document.getElementById("clinicRequestForm");
  const desc=f2.querySelector('textarea[name="urun"]');
  const qty=f2.querySelector('input[name="miktar"]');
  const unit=f2.querySelector('select[name="birim"]');
  const termin=f2.querySelector('input[name="termin"]');
  const scoreEl=document.getElementById("briefScore");
  const tipsEl=document.getElementById("briefTips");
  function updBrief(){
    const {score,tips}=computeBriefScore(desc.value, Number(qty.value||0), unit.value, termin.value);
    scoreEl.textContent=score;
    tipsEl.textContent = (tips.length? ((CUR_LANG==='tr'?"Öneri:":"Tip:")+" "+tips.slice(0,3).join(" · ")) : (CUR_LANG==='tr'?"Harika, brief güçlü görünüyor.":"Great, the brief looks strong."));
  }
  [desc,qty,unit,termin].forEach(el=>el.addEventListener("input",updBrief));
  f1.addEventListener("submit",(e)=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const prof={ org:fd.get("org").trim(), name:fd.get("name").trim(), phone:fd.get("phone").trim(), group:fd.get("group")?.trim()||"", email:fd.get("email").trim() };
    clinicProfiles[prof.email]=prof; localStorage.setItem(LS.currentClinic, prof.email); saveAll();
    toast(CUR_LANG==='tr'?"Klinik profili yüklendi.":"Clinic profile loaded.","success"); renderClinicDash();
  });
  document.getElementById("genInvite").addEventListener("click",()=>{
    const email=currentClinicEmail(); if(!email){ toast(CUR_LANG==='tr'?"Önce klinik profiliyle giriş yapın.":"Please load your clinic profile first.","error"); return; }
    const token=Math.random().toString(36).slice(2,10);
    const url=location.origin+location.pathname+"#supplier?token="+token;
    document.getElementById("inviteOut").innerHTML=`Davet linki: <a href="${url}">${url}</a>`;
    toast(CUR_LANG==='tr'?"Davet linki üretildi.":"Invite link generated.","success");
  });
  f2.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const email=currentClinicEmail(); if(!email){ toast(CUR_LANG==='tr'?"Önce klinik profiliyle giriş yapın.":"Please load your clinic profile first.","error"); return; }
    const prof=clinicProfiles[email]; if(!prof){ toast(CUR_LANG==='tr'?"Profil bulunamadı.":"Profile not found.","error"); return; }
    const fd=new FormData(e.target);
    const file=fd.get("file");
    let file64=null;
    if(file && file.size){
      const b=await file.arrayBuffer(); file64 = "data:"+file.type+";base64,"+btoa(String.fromCharCode(...new Uint8Array(b))).slice(0,200000);
    }
    const rec={
      id: tid(),
      klinik: prof.org, klinik_email: email, yetkili: prof.name,
      kategori: fd.get("kategori"), urun: fd.get("urun").trim(),
      miktar: parseFloat(fd.get("miktar")), birim: fd.get("birim"),
      termin: fd.get("termin"), vis: fd.get("vis"), status: fd.get("status")||"open",
      iot: fd.get("iot")||"No",
      group: prof.group||"",
      file:file64, token: (fd.get("vis")==="private" ? Math.random().toString(36).slice(2,10) : null),
      _when: new Date().toISOString()
    };
    clinicReqs.unshift(rec); saveAll(); e.target.reset();
    // Clear selectedCategory once used
    selectedCategory=""; localStorage.removeItem(LS.selectedCategory);
    renderClinicDash(); renderRequestsPublic();
    toast(`${CUR_LANG==='tr'?"Talep yayınlandı:":"Request published:"} <b>${rec.id}</b>`,"success"); showOK();
    sendEmail(`Meditek | Klinik Talebi | ${rec.id} | ${rec.klinik}`, {...rec,form:"clinic"});
  });
}
function renderClinicDash(){
  const email=currentClinicEmail(); const info=document.getElementById("clinicProfileInfo");
  if(email && clinicProfiles[email]){
    const p=clinicProfiles[email];
    info.innerHTML=`<b>${I18N[CUR_LANG].ctaClinic || 'Aktif Profil'}:</b> ${p.org} — <span class="tag">${p.email}</span> ${p.group?'<span class="badge-chip">'+p.group+'</span>':''}`;
  }else info.innerHTML=`<span class="section-note">${CUR_LANG==='tr'?'Henüz aktif profil yok. Formu doldurun.':'No active profile yet. Fill the form.'}</span>`;
  // prefill category if selected
  if(selectedCategory){
    const sel = document.querySelector('#clinicRequestForm select[name="kategori"]');
    if(sel){ for(let i=0;i<sel.options.length;i++){ if(sel.options[i].value===selectedCategory){ sel.selectedIndex=i; break; } } }
  }
  // Benim taleplerim
  const tbody=document.querySelector("#myClinicReqs tbody");
  const cards=document.getElementById("myClinicReqsCards");
  const my=clinicReqs.filter(r=>r.klinik_email===email);
  if(!my.length){
    tbody.innerHTML=`<tr><td colspan="9" class="text-muted">${CUR_LANG==='tr'?'Kayıt yok.':'No records.'}</td></tr>`;
    cards.innerHTML='';
  }else{
    tbody.innerHTML=my.map(r=>
      `<tr>
        <td>${r.id}</td>
        <td><i class="fa ${categoryIcon(r.kategori)}"></i> ${r.urun}</td>
        <td>${r.kategori}</td>
        <td>${r.miktar} ${r.birim}</td>
        <td>${r.termin}</td>
        <td>${r.status}</td>
        <td>${r.iot||"No"}</td>
        <td><button class="btnx alt btn-sm" onclick="deleteRequest('${r.id}')"><i class="fa-solid fa-trash"></i></button></td>
        <td>${fmtDateTime(r._when)}</td>
      </tr>`
    ).join("");
    cards.innerHTML=my.map(r=>
      `<div class="item-card">
        <div class="d-flex justify-content-between">
          <div><b>${r.urun}</b> <span class="tag">${r.id}</span></div>
          <div class="smallmut">${r.status}</div>
        </div>
        <div class="smallmut"><i class="fa ${categoryIcon(r.kategori)}"></i> ${r.kategori} • ${r.miktar} ${r.birim} • Termin ${r.termin} • IoT: ${r.iot||"No"}</div>
        ${r.file? `<div class="mt-1"><a target="_blank" href="${r.file}">${CUR_LANG==='tr'?'Ek dosya':'Attachment'}</a></div>`:""}
        <div class="mt-2 d-flex gap-2">
          <button class="btnx alt btn-sm" onclick="deleteRequest('${r.id}')"><i class="fa-solid fa-trash"></i> ${CUR_LANG==='tr'?'Sil':'Delete'}</button>
        </div>
      </div>`
    ).join("");
  }
  // Mesajlar
  const msgBox=document.getElementById("clinicMessages");
  const msgs=(messagesMap[email]||[]);
  const sorted=msgs.slice().sort((a,b)=>{
    const score=(m)=>{
      let s=0;
      if(favSuppliers.includes(m.email)) s+=4;
      if((supplierProfiles[m.email]?.premium||"no")==="yes") s+=2;
      if((m.sponsor||"no")==="yes") s+=1;
      return s;
    };
    const sa=score(a), sb=score(b);
    if(sa!==sb) return sb-sa;
    if(a.fiyat!=null && b.fiyat!=null && a.fiyat!==b.fiyat) return a.fiyat-b.fiyat;
    return new Date(b._when)-new Date(a._when);
  });
  if(!sorted.length){ msgBox.innerHTML=`<div class="empty">${CUR_LANG==='tr'?'Tedarikçi mesajı/teklifi yok.':'No supplier messages/offers.'}</div>`; }
  else{
    msgBox.innerHTML=sorted.map(m=>{
      const expired = m.valid_until && (new Date(m.valid_until) < new Date());
      const selected = m.status === 'selected';
      const supplyTimeline = getSupplyTimeline(m.talep_id);
      const supplyStage = getSupplyCurrentStage(m.talep_id);
      const favBadge = favSuppliers.includes(m.email) ? '<i class="fa-solid fa-star text-warning"></i>' : '';
      const premiumBadge = ((supplierProfiles[m.email]?.premium||"no") === 'yes') ? '<span class="badge bg-warning text-dark ms-1">Premium</span>' : '';
      const sponsorBadge = ((m.sponsor||"no") === 'yes') ? '<span class="badge bg-info text-dark ms-1">Sponsor</span>' : '';
      // rozet calculation
      let rozetHtml='';
      const sp = supplierProfiles[m.email];
      if(sp){
        let count=0;
        if(sp.tax) count++;
        if(sp.mersis) count++;
        if(sp.docs && sp.docs.length) count++;
        if(sp.uts) count++;
        let rozetKey='rozetPending';
        if(count>=4) rozetKey='rozetFull'; else if(count>=2) rozetKey='rozetPartial';
        const cls = rozetKey==='rozetFull'?'rozet-full':rozetKey==='rozetPartial'?'rozet-partial':'rozet-pending';
        rozetHtml = `<span class="rozet-badge ${cls}" data-i18n="${rozetKey}">${I18N[CUR_LANG][rozetKey]||''}</span>`;
      }
      // contact mask
      const contact = selected ? (`<a href="mailto:${m.email}">${m.email}</a> • ${m.telefon||''}`) : `<span class="text-muted">${CUR_LANG==='tr'?'Gizli':'Hidden'}</span>`;
      // extra warranty & maintenance info
      let extra="";
      const wY = parseFloat(m.warranty||"0");
      const mM = parseFloat(m.maintenance||"0");
      if(wY>0 || mM>0){
        const start = new Date(m._when);
        let warrantyEndStr="";
        let nextMaintStr="";
        if(wY>0){
          const we = new Date(start);
          we.setFullYear(we.getFullYear() + wY);
          warrantyEndStr = we.toLocaleDateString();
        }
        if(mM>0){
          let nm = new Date(start);
          const now = new Date();
          while(nm < now){ nm.setMonth(nm.getMonth() + mM); }
          nextMaintStr = nm.toLocaleDateString();
        }
        extra = `<div class="smallmut">${CUR_LANG==='tr'?'Garanti':'Warranty'}: ${wY} ${CUR_LANG==='tr'?'yıl':'year'}, ${CUR_LANG==='tr'?'Bakım':'Maintenance'}: ${mM} ${CUR_LANG==='tr'?'ay':'month'}${warrantyEndStr ? ' • '+(CUR_LANG==='tr'?'Garanti bitişi':'Warranty end')+': '+warrantyEndStr : ''}${nextMaintStr ? ' • '+(CUR_LANG==='tr'?'Sonraki bakım':'Next maintenance')+': '+nextMaintStr : ''}</div>`;
      }
      const stockInfo = (m.stock!=null && !isNaN(m.stock) && m.stock>0) ? `<div class="smallmut">${CUR_LANG==='tr'?'Stok':'Stock'}: ${m.stock}</div>` : '';
      return `
      <div class="msg-card">
        <div class="d-flex justify-content-between">
          <div><b>${m.firma}</b> ${favBadge}${premiumBadge}${sponsorBadge} ${rozetHtml} — <span class="tag">${m.talep_id}</span> ${expired?'<span class="badge bg-secondary ms-1">'+(CUR_LANG==='tr'?'Süresi doldu':'Expired')+'</span>':''} ${selected?'<span class="badge bg-success ms-1">'+(CUR_LANG==='tr'?'Onaylandı':'Selected')+'</span>':''}</div>
          <div class="smallmut">${fmtDateTime(m._when)}</div>
        </div>
        <div class="mt-1">${CUR_LANG==='tr'?'Fiyat':'Price'}: <b>${m.fiyat} ${m.para}</b> • ${CUR_LANG==='tr'?'Termin':'Lead'}: <b>${m.termin_gun} ${CUR_LANG==='tr'?'gün':'days'}</b></div>
        ${extra}
        ${stockInfo}
        <div class="section-note mt-1">${m.not||""}</div>
        ${m.file? `<div class="mt-1"><a target="_blank" href="${m.file}">${CUR_LANG==='tr'?'Ek katalog/Belge':'Attachment'}</a></div>`:""}
        <div class="small mt-2">${CUR_LANG==='tr'?'İletişim':'Contact'}: ${contact}</div>
        ${selected? `<div class="supply-status mt-2">
            ${supplyTimeline.map(t=>`<span class="stage ${t.stage===supplyStage?'current':''}">${t.stage}</span>`).join('')}
          </div>`:''}
        <div class="mt-2 d-flex gap-2 flex-wrap">
          ${selected? `<button class="btnx btn-sm" onclick="progressSupplyChain('${m.talep_id}')">${CUR_LANG==='tr'?'Sonraki Aşama':'Next Stage'}</button><a class="btnx alt btn-sm" href="${generateContractLink(m)}" download>📄 ${CUR_LANG==='tr'?'Sözleşme':'Contract'}</a>`:`<button class="btnx btn-sm" onclick="selectOffer('${m.talep_id}','${m._id||''}')">${CUR_LANG==='tr'?'Teklifi Seç':'Select Offer'}</button>`}
          <button class="btnx alt btn-sm" onclick="favSupplier('${m.email}')"><i class="fa-regular fa-star"></i> ${CUR_LANG==='tr'?'Favori':'Favorite'}</button>
        </div>
        <div class="mt-2">
          <div class="smallmut">${CUR_LANG==='tr'?'Yorumlar':'Comments'}</div>
          <div id="cmt-${m._id||''}"></div>
          <div class="input-group input-group-sm mt-1">
            <input class="form-control" placeholder="${CUR_LANG==='tr'?'Yorum yaz…':'Write a comment…'}" id="cmi-${m._id||''}">
            <button class="btn btn-dark" onclick="addComment('${m._id||''}')">${CUR_LANG==='tr'?'Ekle':'Add'}</button>
          </div>
        </div>
      </div>`;
    }).join("");
  }
  updateStats();
}

/* ========= SUPPLIER ========= */
function bindSupplier(){
  const f1=document.getElementById("supplierProfileForm");
  const f2=document.getElementById("supplierBidForm");
  f1.addEventListener("submit",async (e)=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    let docsData=[];
    const docs=fd.getAll("docs");
    for(const file of docs){
      if(file && file.size){
        const b=await file.arrayBuffer(); const base="data:"+file.type+";base64,"+btoa(String.fromCharCode(...new Uint8Array(b))).slice(0,200000);
        docsData.push(base);
      }
    }
    const prof={
      company:fd.get("company").trim(),
      name:fd.get("name").trim(),
      phone:fd.get("phone").trim(),
      email:fd.get("email").trim(),
      premium: fd.get("premium")||"no",
      tax: fd.get("tax")?.trim()||"",
      mersis: fd.get("mersis")?.trim()||"",
      docs: docsData,
      uts: fd.get("uts")?.trim()||""
    };
    supplierProfiles[prof.email]=prof;
    localStorage.setItem(LS.currentSupplier, prof.email);
    // calculate rosette status
    let count=0;
    if(prof.tax) count++;
    if(prof.mersis) count++;
    if(prof.docs && prof.docs.length) count++;
    if(prof.uts) count++;
    if(count>=4) prof.rozet="rozetFull"; else if(count>=2) prof.rozet="rozetPartial"; else prof.rozet="rozetPending";
    saveAll();
    toast(CUR_LANG==='tr'?"Tedarikçi profili yüklendi.":"Supplier profile loaded.","success");
    renderSupplierDash();
  });
  f2.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const semail=currentSupplierEmail(); if(!semail){ toast(CUR_LANG==='tr'?"Önce tedarikçi profiliyle giriş yapın.":"Please load your supplier profile first.","error"); return; }
    const sprof=supplierProfiles[semail];
    const fd=new FormData(e.target);
    const talep_id=fd.get("talep_id").trim();
    const target=clinicReqs.find(r=>r.id===talep_id);
    if(!target){ toast(CUR_LANG==='tr'?"Talep ID bulunamadı.":"Request ID not found.","error"); return; }
    const existing = supplierBids.find(b=>b.talep_id===talep_id && b.email===semail);
    if(existing){ toast(CUR_LANG==='tr'?"Bu talep için zaten teklif verdiniz.":"You already placed a bid for this request.","error"); return; }
    const file=fd.get("file");
    let file64=null;
    if(file && file.size){
      const b=await file.arrayBuffer(); file64 = "data:"+file.type+";base64,"+btoa(String.fromCharCode(...new Uint8Array(b))).slice(0,200000);
    }
    const now=new Date();
    const validDays=parseInt(fd.get("valid_days")||"7",10);
    const rec={
      _id: "BID-"+now.getTime()+"-"+Math.floor(Math.random()*1000),
      talep_id,
      firma: sprof.company,
      yetkili: sprof.name,
      telefon: sprof.phone,
      email: sprof.email,
      fiyat: parseFloat(fd.get("fiyat")),
      para: fd.get("para"),
      termin_gun: parseInt(fd.get("termin_gun"),10),
      valid_days: validDays,
      valid_until: new Date(now.getTime()+validDays*86400000).toISOString(),
      not: fd.get("not")?.trim()||"",
      file:file64,
      _when: now.toISOString(),
      comments:[],
      status: 'pending',
      stock: parseFloat(fd.get("stock")||"0"),
      sponsor: fd.get("sponsor")||"no",
      warranty: parseFloat(fd.get("warranty")||"0"),
      maintenance: parseFloat(fd.get("maintenance")||"0")
    };
    supplierBids.unshift(rec);
    const cemail = target.klinik_email;
    messagesMap[cemail] = messagesMap[cemail] || [];
    messagesMap[cemail].unshift(rec);
    saveAll(); e.target.reset(); renderSupplierDash(); if(currentClinicEmail()===cemail) renderClinicDash();
    toast(`${CUR_LANG==='tr'?"Teklif gönderildi:":"Bid sent:"} <b>${talep_id}</b>`,"success"); showOK();
    toast("🔔 "+(CUR_LANG==='tr'?"Yeni teklifiniz var":"You have a new bid"),"info");
    sendEmail(`Meditek | Teklif | ${rec.talep_id} | ${rec.firma}`, {...rec, klinik: target.klinik, klinik_email: cemail, form:"supplier"});
    sendEmail(`Meditek | ${target.klinik} için yeni teklif | ${rec.firma}`, {...rec, to:cemail});
  });
}
function prefillBid(id){ document.getElementById("bidTalepId").value=id; }
function renderSupplierDash(){
  const email=currentSupplierEmail(); const info=document.getElementById("supplierProfileInfo");
  if(email && supplierProfiles[email]){
    const p=supplierProfiles[email];
    // compute rozet display
    let rozetKey=p.rozet||'rozetPending';
    let cls = rozetKey==='rozetFull'?'rozet-full':rozetKey==='rozetPartial'?'rozet-partial':'rozet-pending';
    const rozetHtml = `<span class="rozet-badge ${cls}" data-i18n="${rozetKey}">${I18N[CUR_LANG][rozetKey]||''}</span>`;
    info.innerHTML=`<b>${I18N[CUR_LANG].ctaSupplier || 'Aktif Profil'}:</b> ${p.company} — <span class="tag">${p.email}</span>${rozetHtml}`;
  }else info.innerHTML=`<span class="section-note">${CUR_LANG==='tr'?'Henüz aktif profil yok. Formu doldurun.':'No active profile yet. Fill the form.'}</span>`;
  // Açık talepler listesi (filtreler)
  const q=(document.getElementById("searchReq")?.value||"").toLowerCase();
  const cat=(document.getElementById("filterCat")?.value||"");
  const st=(document.getElementById("filterStatus")?.value||"");
  let arr=[...clinicReqs].filter(r=>r.vis==="public");
  const token=new URLSearchParams((location.hash.split("?")[1]||"")).get("token");
  if(token) arr = clinicReqs.filter(r=> r.vis==="public" || r.token===token);
  if(q) arr=arr.filter(r=> (r.urun||"").toLowerCase().includes(q) || (r.klinik||"").toLowerCase().includes(q));
  if(cat) arr=arr.filter(r=> r.kategori===cat);
  if(st) arr=arr.filter(r=> r.status===st);
  const tbody=document.querySelector("#reqTableSup tbody");
  const cards=document.getElementById("reqTableSupCards");
  if(!arr.length){ tbody.innerHTML=`<tr><td colspan="9" class="text-muted">${CUR_LANG==='tr'?'Kayıt yok.':'No records.'}</td></tr>`; cards.innerHTML=''; }
  else{
    tbody.innerHTML=arr.map(r=>
      `<tr>
        <td>${r.id}</td><td>${r.klinik}</td>
        <td><i class="fa ${categoryIcon(r.kategori)}"></i> ${r.urun}</td>
        <td>${r.kategori}</td><td>${r.miktar} ${r.birim}</td><td>${r.termin}</td>
        <td>${r.status}</td>
        <td>${r.iot||"No"}</td>
        <td class="text-nowrap">
          <button class="btnx btn-sm" onclick="prefillBid('${r.id}')">${CUR_LANG==='tr'?'Teklif Ver':'Bid'}</button>
          <button class="btnx alt btn-sm" onclick="favClinic('${r.klinik_email}')"><i class="fa-regular fa-star"></i></button>
        </td>
      </tr>`
    ).join("");
    cards.innerHTML=arr.map(r=>
      `<div class="item-card">
        <div class="d-flex justify-content-between">
          <div><b>${r.urun}</b> <span class="tag">${r.id}</span></div>
          <div class="smallmut">${r.status}</div>
        </div>
        <div class="smallmut"><i class="fa ${categoryIcon(r.kategori)}"></i> ${r.klinik} • ${r.kategori} • ${r.miktar} ${r.birim} • Termin ${r.termin} • IoT: ${r.iot||"No"}</div>
        <div class="mt-2 d-flex gap-2">
          <button class="btnx btn-sm" onclick="prefillBid('${r.id}')">${CUR_LANG==='tr'?'Teklif Ver':'Bid'}</button>
          ${r.file? `<a class="btnx alt btn-sm" target="_blank" href="${r.file}">${CUR_LANG==='tr'?'Ek':'Attachment'}</a>`:""}
        </div>
      </div>`
    ).join("");
  }
  // kendi teklifleri listesi
  const myBids = supplierBids.filter(b=>b.email===email);
  const section=document.getElementById("supplierBidsSection");
  const tb=document.querySelector("#myBidTable tbody");
  const cardsB=document.getElementById("myBidCards");
  if(!myBids.length){
    section.style.display="none";
  }else{
    section.style.display="block";
    tb.innerHTML=myBids.map(b=>{
      const stage = getSupplyCurrentStage(b.talep_id);
      const statusLabel = b.status==='selected' ? (CUR_LANG==='tr'?'Onaylandı':'Selected') : (b.status==='not_selected'? (CUR_LANG==='tr'?'Seçilmedi':'Not Selected') : (CUR_LANG==='tr'?'Beklemede':'Pending'));
      const contractLinkHtml = b.status==='selected' ? `<a class="btnx alt btn-sm" href="${generateContractLink(b)}" download>${CUR_LANG==='tr'?'Sözleşme':'Contract'}</a>` : '';
      const stockCell = (b.stock!=null && !isNaN(b.stock) && b.stock>0) ? b.stock : '';
      const sponsorCell = (b.sponsor||"no")==="yes" ? '✓' : '';
      return `<tr><td>${b.talep_id}</td><td>${b.fiyat} ${b.para}</td><td>${stockCell}</td><td>${sponsorCell}</td><td>${statusLabel}</td><td>${b.status==='selected'?stage:'--'}</td><td>${contractLinkHtml}</td></tr>`;
    }).join("");
    cardsB.innerHTML=myBids.map(b=>{
      const stage = getSupplyCurrentStage(b.talep_id);
      const statusLabel = b.status==='selected' ? (CUR_LANG==='tr'?'Onaylandı':'Selected') : (b.status==='not_selected'? (CUR_LANG==='tr'?'Seçilmedi':'Not Selected') : (CUR_LANG==='tr'?'Beklemede':'Pending'));
      const contractHtml = b.status==='selected' ? `<div class="smallmut">${CUR_LANG==='tr'?'Aşama':'Stage'}: ${stage}</div><a class="btnx alt btn-sm mt-1" href="${generateContractLink(b)}" download>${CUR_LANG==='tr'?'Sözleşme':'Contract'}</a>` : '';
      const stockInfo = (b.stock!=null && !isNaN(b.stock) && b.stock>0) ? `<div class="smallmut">${CUR_LANG==='tr'?'Stok':'Stock'}: ${b.stock}</div>` : '';
      const sponsorLabel = (b.sponsor||"no")==="yes" ? '<span class="badge bg-info text-dark ms-1">Sponsor</span>' : '';
      return `<div class="item-card">
        <div class="d-flex justify-content-between"><b>${b.talep_id}</b><span class="smallmut">${statusLabel}</span></div>
        <div class="smallmut">${b.fiyat} ${b.para} • ${b.termin_gun}${CUR_LANG==='tr'?'g':'d'} ${sponsorLabel}</div>
        ${stockInfo}
        ${contractHtml}
      </div>`;
    }).join("");
  }
}

/* ========= PUBLIC REQUESTS ========= */
function bindSearchFilters(){
  ["searchReq","filterCat","filterStatus","searchReqPub","filterCatPub","filterStatusPub","sortReq"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener("input", ()=>{ renderSupplierDash(); renderRequestsPublic(); });
  });
}
function renderRequestsPublic(){
  const q=(document.getElementById("searchReqPub")?.value||"").toLowerCase();
  const cat=(document.getElementById("filterCatPub")?.value||"");
  const st=(document.getElementById("filterStatusPub")?.value||"");
  const sort=(document.getElementById("sortReq")?.value||"new");
  let arr=[...clinicReqs].filter(r=>r.vis==="public");
  if(q) arr=arr.filter(r=> (r.urun||"").toLowerCase().includes(q) || (r.klinik||"").toLowerCase().includes(q));
  if(cat) arr=arr.filter(r=> r.kategori===cat);
  if(st) arr=arr.filter(r=> r.status===st);
  if(sort==="qty") arr.sort((a,b)=> (b.miktar||0)-(a.miktar||0));
  else if(sort==="date") arr.sort((a,b)=> new Date(a.termin)-new Date(b.termin));
  else arr.sort((a,b)=> new Date(b._when)-new Date(a._when));
  const tbody=document.querySelector("#reqTablePub tbody");
  const cards=document.getElementById("reqTablePubCards");
  if(!arr.length){ tbody.innerHTML=`<tr><td colspan="8" class="text-muted">${CUR_LANG==='tr'?'Kayıt yok.':'No records.'}</td></tr>`; cards.innerHTML=''; }
  else{
    tbody.innerHTML=arr.map(r=>
      `<tr>
        <td>${r.id}</td><td>${r.klinik}</td><td><i class="fa ${categoryIcon(r.kategori)}"></i> ${r.urun}</td>
        <td>${r.kategori}</td><td>${r.miktar} ${r.birim}</td><td>${r.termin}</td><td>${r.status}</td><td>${r.iot||"No"}</td>
      </tr>`
    ).join("");
    cards.innerHTML=arr.map(r=>
      `<div class="item-card">
        <div class="d-flex justify-content-between">
          <div><b>${r.urun}</b> <span class="tag">${r.id}</span></div>
          <div class="smallmut">${r.status}</div>
        </div>
        <div class="smallmut"><i class="fa ${categoryIcon(r.kategori)}"></i> ${r.klinik} • ${r.kategori} • ${r.miktar} ${r.birim} • Termin ${r.termin} • IoT: ${r.iot||"No"}</div>
      </div>`
    ).join("");
  }
}

/* ========= Durum Yönetimi, Favoriler, Yorum ========= */
function selectOffer(talepId, bidId){
  const req = clinicReqs.find(r=>r.id===talepId);
  if(!req){ toast(CUR_LANG==='tr'?"Talep bulunamadı.":"Request not found.","error"); return; }
  req.status="selected";
  supplierBids.forEach(b=>{
    if(b.talep_id===talepId){
      if((b._id||"")===bidId){ b.status = 'selected'; }
      else { b.status = 'not_selected'; }
    }
  });
  Object.keys(messagesMap).forEach(key=>{
    messagesMap[key] = messagesMap[key].map(m=>{
      if(m.talep_id===talepId){
        if((m._id||"")===bidId) m.status='selected'; else m.status='not_selected';
      }
      return m;
    });
  });
  initTracking(talepId);
  saveAll();
  renderClinicDash(); renderRequestsPublic(); renderSupplierDash();
  toast(CUR_LANG==='tr'?"Teklif seçildi. Talep durumu: Seçildi":"Offer selected. Request status: Selected","success");
}
function favSupplier(email){
  if(!favSuppliers.includes(email)) favSuppliers.push(email);
  saveAll(); updateStats(); toast(CUR_LANG==='tr'?"Favorilere eklendi.":"Added to favorites.","success"); renderClinicDash();
}
function favClinic(email){
  if(!favClinics.includes(email)) favClinics.push(email);
  saveAll(); toast(CUR_LANG==='tr'?"Klinik favorilere eklendi.":"Clinic added to favorites.","success");
}
function addComment(bidId){
  const cmi=document.getElementById("cmi-"+bidId);
  const txt=cmi?.value?.trim(); if(!txt) return;
  const bid = supplierBids.find(b=> (b._id||"")===bidId );
  if(!bid) return;
  bid.comments = bid.comments||[]; bid.comments.push({by:"clinic",text:txt,at:new Date().toISOString()});
  cmi.value=""; saveAll(); renderClinicDash();
}

/* ========= Silme fonksiyonu ========= */
function deleteRequest(reqId){
  if(!confirm(CUR_LANG==='tr'?"Bu talebi ve ilişkili teklifleri silmek istiyor musun?":"Delete this request and its related bids?")) return;
  clinicReqs = clinicReqs.filter(r=>r.id!==reqId);
  supplierBids = supplierBids.filter(b=>b.talep_id!==reqId);
  Object.keys(messagesMap).forEach(k=>{
    messagesMap[k] = messagesMap[k].filter(m=>m.talep_id!==reqId);
  });
  delete supplyTracking[reqId];
  Object.keys(contracts).forEach(cid=>{ if(contracts[cid].talepId===reqId) delete contracts[cid]; });
  saveAll(); renderClinicDash(); renderSupplierDash(); renderRequestsPublic(); renderAdmin();
  toast(CUR_LANG==='tr'?"Talep ve ilişkili veriler silindi.":"Request and associated data deleted.","success");
}

/* ========= ADMIN ========= */
function bindAdmin(){
  document.getElementById("exportCSV").addEventListener("click",()=>{
    const lines=[];
    lines.push("=== Klinik Talepleri ===");
    lines.push("ID,Klinik,Grup,Kategori,Urun,Miktar,Birim,Termin,Durum,IoT,Vis,Yetkili,Eposta,Tarih");
    clinicReqs.forEach(r=>lines.push([r.id,r.klinik,r.group||"",r.kategori,(r.urun||"").replaceAll(",",";"),r.miktar,r.birim,r.termin,r.status,r.iot||"No",r.vis,r.yetkili,r.klinik_email,r._when].map(v=>`\"${String(v).replaceAll('"','""')}\"`).join(",")));
    lines.push("");
    lines.push("=== Tedarikçi Teklifleri ===");
    lines.push("TalepID,Firma,Fiyat,Para,TerminGun,GecerlilikGun,Stok,Sponsor,GarantiYil,BakimAy,Durum,Yetkili,Eposta,Tarih");
    supplierBids.forEach(r=>lines.push([
      r.talep_id,
      r.firma,
      r.fiyat,
      r.para,
      r.termin_gun,
      r.valid_days,
      (r.stock!=null && !isNaN(r.stock) && r.stock>0)? r.stock : "",
      (r.sponsor||"no") === "yes" ? "yes" : "",
      r.warranty||"",
      r.maintenance||"",
      r.status,
      r.yetkili,
      r.email,
      r._when
    ].map(v=>`\"${String(v).replaceAll('"','""')}\"`).join(",")));
    const blob=new Blob(['\uFEFF'+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='meditek-pilot.csv'; a.click();
  });
  document.getElementById("exportJSON").addEventListener("click",()=>{
    const data={clinicReqs,supplierBids,messagesMap,clinicProfiles,supplierProfiles,favSuppliers,favClinics,supplyTracking,contracts,ver:SCHEMA_VER};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='meditek-pilot.json'; a.click();
  });
  document.getElementById("importJSON").addEventListener("change", async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const txt=await f.text();
    try{
      const d=JSON.parse(txt);
      clinicReqs=d.clinicReqs||clinicReqs; supplierBids=d.supplierBids||supplierBids;
      messagesMap=d.messagesMap||messagesMap; clinicProfiles=d.clinicProfiles||clinicProfiles;
      supplierProfiles=d.supplierProfiles||supplierProfiles; favSuppliers=d.favSuppliers||favSuppliers; favClinics=d.favClinics||favClinics;
      supplyTracking=d.supplyTracking||supplyTracking; contracts=d.contracts||contracts;
      saveAll(); toast(CUR_LANG==='tr'?"JSON içe aktarıldı.":"JSON imported.","success"); renderAdmin(); renderRequestsPublic(); renderSupplierDash(); renderClinicDash();
    }catch{ toast(CUR_LANG==='tr'?"JSON okunamadı.":"Failed to parse JSON.","error"); }
  });
  document.getElementById("clearAll").addEventListener("click",()=>{
    if(!confirm(CUR_LANG==='tr'?"Tüm yerel verileri (profil, talep, teklif, mesaj) silmek istiyor musun?":"Delete all local data (profiles, requests, bids, messages)?")) return;
    clinicReqs=[]; supplierBids=[]; messagesMap={}; clinicProfiles={}; supplierProfiles={}; favSuppliers=[]; favClinics=[]; supplyTracking={}; contracts={}; selectedCategory="";
    saveAll(); toast(CUR_LANG==='tr'?"Tüm veriler temizlendi.":"All data cleared.","success"); renderClinicDash(); renderSupplierDash(); renderRequestsPublic(); renderAdmin(); renderHome();
  });
}
function renderAdmin(){
  const tb1=document.querySelector("#tblClinicAdmin tbody");
  const cards1=document.getElementById("tblClinicAdminCards");
  if(!clinicReqs.length){ tb1.innerHTML=`<tr><td colspan="12" class="text-muted">${CUR_LANG==='tr'?'Kayıt yok.':'No records.'}</td></tr>`; cards1.innerHTML=''; }
  else{
    tb1.innerHTML=clinicReqs.map(r=>
      `<tr>
        <td>${r.id}</td><td>${r.klinik}</td><td>${r.group||""}</td><td>${r.urun}</td><td>${r.kategori}</td>
        <td>${r.miktar} ${r.birim}</td><td>${r.termin}</td><td>${r.status}</td><td>${r.iot||"No"}</td><td>${r.yetkili}</td><td>${r.klinik_email}</td><td>${fmtDateTime(r._when)}</td>
      </tr>`
    ).join("");
    cards1.innerHTML=clinicReqs.map(r=>
      `<div class="item-card">
        <div class="d-flex justify-content-between"><b>${r.urun}</b><span class="smallmut">${r.status}</span></div>
        <div class="smallmut">${r.klinik} • ${r.kategori} • ${r.miktar} ${r.birim} • ${r.termin} • IoT: ${r.iot||"No"}</div>
        <div class="smallmut">${r.klinik_email}</div>
      </div>`
    ).join("");
  }
  const tb2=document.querySelector("#tblSuppAdmin tbody");
  const cards2=document.getElementById("tblSuppAdminCards");
  if(!supplierBids.length){ tb2.innerHTML=`<tr><td colspan="14" class="text-muted">${CUR_LANG==='tr'?'Kayıt yok.':'No records.'}</td></tr>`; cards2.innerHTML=''; }
  else{
    tb2.innerHTML=supplierBids.map(r=>
      `<tr>
        <td>${r.talep_id}</td><td>${r.firma}</td><td>${r.fiyat}</td><td>${r.para}</td>
        <td>${r.termin_gun}</td><td>${r.valid_days}</td><td>${(r.stock!=null&& !isNaN(r.stock)&&r.stock>0)?r.stock:''}</td><td>${(r.sponsor||"no")==="yes"? (CUR_LANG==='tr'?'Evet':'Yes') : ''}</td><td>${r.warranty||''}</td><td>${r.maintenance||''}</td><td>${r.status}</td><td>${r.yetkili}</td><td>${r.email}</td><td>${fmtDateTime(r._when)}</td>
      </tr>`
    ).join("");
    cards2.innerHTML=supplierBids.map(r=>{
      const sponsorLabel = (r.sponsor||"no")==="yes" ? '<span class="badge bg-info text-dark ms-1">Sponsor</span>' : '';
      const stockInfo = (r.stock!=null && !isNaN(r.stock) && r.stock>0) ? `<div class="smallmut">${CUR_LANG==='tr'?'Stok':'Stock'}: ${r.stock}</div>` : '';
      return `<div class="item-card">
        <div class="d-flex justify-content-between"><b>${r.firma}</b><span class="tag">${r.talep_id}</span></div>
        <div class="smallmut">${r.fiyat} ${r.para} • ${r.termin_gun}${CUR_LANG==='tr'?'g':'d'} • ${CUR_LANG==='tr'?'geçerlilik':'valid'} ${r.valid_days}${CUR_LANG==='tr'?'g':'d'} ${sponsorLabel}</div>
        ${stockInfo}
        <div class="smallmut">${CUR_LANG==='tr'?'Garanti':'Warranty'}: ${r.warranty||0} ${CUR_LANG==='tr'?'yıl':'yr'}, ${CUR_LANG==='tr'?'Bakım':'Maintenance'}: ${r.maintenance||0} ${CUR_LANG==='tr'?'ay':'mo'}</div>
        <div class="smallmut">${r.status}</div>
        <div class="smallmut">${r.email}</div>
      </div>`;
    }).join("");
  }
}

/* ========= HOME (stats + chart) ========= */
let trendChart;
let forecastChart;
function renderHome(){
  updateStats();
  // Trend chart
  const ctx=document.getElementById("trendChart");
  if(ctx){
    const last10=[...supplierBids].slice(0,10);
    const labels=last10.map(b=>b.talep_id.slice(-4));
    const data=last10.map(b=>b.fiyat||0);
    if(trendChart){ trendChart.destroy(); }
    trendChart=new Chart(ctx,{type:'line', data:{labels, datasets:[{label:'Avg Unit Price', data, tension:.3, borderColor:'#0F172A', backgroundColor:'rgba(15,23,42,0.1)'}]} , options:{plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:true}} }});
    // Forecast chart
    const ctx2=document.getElementById("forecastChart");
    if(forecastChart){ forecastChart.destroy(); }
    const len=data.length;
    let pred=[];
    if(len>=2){
      const xs=data.map((_,i)=>i);
      const sumX=xs.reduce((a,b)=>a+b,0);
      const sumY=data.reduce((a,b)=>a+b,0);
      const sumXY=xs.reduce((a,b,i)=>a + b*data[i],0);
      const sumX2=xs.reduce((a,b)=>a+b*b,0);
      const n=len;
      const slope=(n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
      const intercept=(sumY - slope*sumX)/n;
      for(let i=0;i<3;i++){
        const x=len + i;
        pred.push(slope*x + intercept);
      }
    }
    const forecastLabels = labels.concat(['+1','+2','+3']);
    const allData = data.concat(pred);
    forecastChart=new Chart(ctx2,{type:'line', data:{labels: forecastLabels, datasets:[
      {label:'Gerçek', data: allData, tension:.3, borderColor:'#0F172A', backgroundColor:'rgba(15,23,42,0.1)'},
      {label:'Tahmin', data: [null,...pred], tension:.3, borderColor:'#EF4444', borderDash:[6,4], backgroundColor:'rgba(239,68,68,0.1)'}
    ]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:true}} }});
  }
  renderAnalytics();
}
/* ========= Pazar Analitiği ========= */
function renderAnalytics(){
  const container=document.getElementById('analyticsContent');
  if(!container) return;
  const catData={};
  clinicReqs.forEach(r=>{
    const c=r.kategori;
    catData[c]=catData[c]||{count:0,totalPrice:0,bidCount:0};
    catData[c].count++;
  });
  supplierBids.forEach(b=>{
    const req=clinicReqs.find(r=>r.id===b.talep_id);
    if(req){
      const c=req.kategori;
      catData[c]=catData[c]||{count:0,totalPrice:0,bidCount:0};
      catData[c].totalPrice += (b.fiyat||0);
      catData[c].bidCount++;
    }
  });
  const items=Object.keys(catData).map(k=>{
    const d=catData[k];
    const avg=(d.bidCount? (d.totalPrice/d.bidCount).toFixed(1) : '—');
    return {cat:k,count:d.count,avg:avg};
  }).sort((a,b)=>b.count-a.count).slice(0,5);
  let html='<table class="table table-sm align-middle"><thead><tr><th>'+ (CUR_LANG==='tr'?'Kat.':'Cat.') +'</th><th>'+ (CUR_LANG==='tr'?'Talep':'Req.') +'</th><th>'+ (CUR_LANG==='tr'?'Avg Fiyat':'Avg Price') +'</th></tr></thead><tbody>';
  if(!items.length){ html += '<tr><td colspan="3" class="text-muted">'+(CUR_LANG==='tr'?'Veri yok.':'No data.')+'</td></tr>'; }
  else{
    items.forEach(it=>{ html += `<tr><td>${it.cat}</td><td>${it.count}</td><td>${it.avg}</td></tr>`; });
  }
  html += '</tbody></table>';
  container.innerHTML=html;
}

function updateStats(){
  document.getElementById("statTotal").textContent=clinicReqs.length;
  document.getElementById("statAccepted").textContent=clinicReqs.filter(r=>r.status==="selected").length;
  document.getElementById("statFav").textContent=favSuppliers.length;
  let total=0, count=0;
  clinicReqs.forEach(r=>{
    const bids = supplierBids.filter(b=>b.talep_id===r.id);
    if(bids.length){
      const dt=(new Date(bids[bids.length-1]._when)-new Date(r._when))/3600000;
      if(dt>=0){ total+=dt; count++; }
    }
  });
  document.getElementById("statAvg").textContent = count? (total/count).toFixed(1)+(CUR_LANG==='tr'?' saat':'h') : '—';
}

/* ========= Demo Centre ========= */
// Generate demo data once (not persisted)
const demoReqs = [];
const demoBids = [];
function generateDemoData(){
  if(demoReqs.length) return;
  const cats=["Medikal Cihaz","Sarf Malzeme","Laboratuvar","Radyoloji","Diş Sağlığı","Hizmet"];
  for(let i=0;i<5;i++){
    const id="DEMO"+(i+1);
    const cat=cats[i];
    demoReqs.push({ id, klinik:"Demo Klinik", urun:`Demo Ürün ${i+1}`, kategori:cat, miktar:10+i*5, birim:"Adet", termin:"2025-09-0"+(i+1), status:'open', iot:'No', _when:new Date(Date.now()-i*86400000).toISOString() });
    // generate 2-3 bids
    for(let j=0;j<2+(i%2);j++){
      const bidPrice=1000 + i*200 + j*50;
      demoBids.push({ talep_id:id, firma:`Demo Tedarikçi ${String.fromCharCode(65+j)}`, fiyat:bidPrice, para:'TRY', termin_gun:7+j*2, not:'', stock: 50-j*5, sponsor: j===0?'yes':'no', warranty:1, maintenance:6, _when:new Date(Date.now()-i*86400000 - j*3600000).toISOString() });
    }
  }
}
function renderDemo(){
  generateDemoData();
  document.getElementById("demoTotal").textContent=demoReqs.length;
  // compute avg offers per RFQ
  const avgOffers = (demoBids.length/demoReqs.length).toFixed(1);
  document.getElementById("demoAvgOffers").textContent=avgOffers;
  // compute avg savings: (max-min)/max across requests
  let totalSave=0, saveCount=0;
  demoReqs.forEach(r=>{
    const bids=demoBids.filter(b=>b.talep_id===r.id);
    if(bids.length>1){
      const prices=bids.map(b=>b.fiyat);
      const max=Math.max(...prices);
      const min=Math.min(...prices);
      const save=((max-min)/max)*100;
      totalSave+=save; saveCount++;
    }
  });
  document.getElementById("demoAvgSavings").textContent= saveCount? (totalSave/saveCount).toFixed(1)+'%' : '—';
  // render requests and offers
  const container=document.getElementById("demoReqs");
  container.innerHTML=demoReqs.map(r=>{
    const bids=demoBids.filter(b=>b.talep_id===r.id);
    return `<div class="msg-card">
      <div class="d-flex justify-content-between"><div><b>${r.urun}</b> <span class="tag">${r.id}</span></div><div class="smallmut">${r.kategori}</div></div>
      <div class="smallmut">${r.miktar} ${r.birim} • ${CUR_LANG==='tr'?'Termin':'Delivery'} ${r.termin}</div>
      <div class="mt-2"><b>${CUR_LANG==='tr'?'Teklifler':'Bids'}</b>:</div>
      <ul class="smallmut" style="margin-left:16px">
        ${bids.map(b=>`${b.firma}: ${b.fiyat} ${b.para} • ${b.termin_gun}${CUR_LANG==='tr'?'g':'d'}${(b.sponsor==="yes"?' • '+(CUR_LANG==='tr'?'Sponsorlu':'Sponsored'):'')}`).join('')}
      </ul>
    </div>`;
  }).join('');
}
function renderTrust(){ /* placeholder for future dynamic behaviours */ }

/* ========= global helpers ========= */
function generateContractLink(bid){
  const existing = Object.values(contracts).find(c=>c.talepId===bid.talep_id && c.tedarikci===bid.firma);
  if(existing){
    const blob = new Blob([JSON.stringify(existing,null,2)], {type:'application/json'});
    return URL.createObjectURL(blob);
  }
  const {url} = generateContract(bid);
  return url;
}
</script>
</body>
</html>
